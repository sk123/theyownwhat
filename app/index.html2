<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Uncover hidden property networks in Connecticut. An advocacy and investigative tool for linking property owners with their business entities for greater transparency.">
  <title>they own WHAT??</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico">

  <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">

  <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">

  <link rel="manifest" href="favicon_io/site.webmanifest">
  <style>
    :root{
      --primary-hue:221; --primary:hsl(var(--primary-hue),83%,53%); --primary-dark:hsl(var(--primary-hue),83%,43%);
      --secondary-hue:162; --secondary:hsl(var(--secondary-hue),72%,46%);
      --danger:#ef4444; --warning:#f59e0b;
      --bg:#f1f5f9; --card-bg:#fff; --text:#0f172a; --text-muted:#64748b; --border:#e2e8f0;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius-md:.375rem; --radius-lg:.5rem;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
    .container{max-width:1400px;margin:0 auto;padding:15px}
    header p{color:var(--text-muted);font-size:.9rem;margin:0}

    /* Buttons & inputs */
    .btn{padding:10px 16px;font-size:.92rem;font-weight:700;border:none;border-radius:var(--radius-md);cursor:pointer;transition:.2s}
    .btn-primary{background:var(--primary);color:#fff;box-shadow:var(--shadow-sm)}
    .btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px)}
    .btn-secondary{background:var(--card-bg);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow-sm)}
    .btn-secondary:hover{background:var(--bg)}
    .btn-purple{background:#8b5cf6;color:#fff}
    .btn-purple:hover{background:#7c3aed}
    .btn-pink{background:#ec4899;color:#fff}
    .btn-pink:hover{background:#db2777}
    .btn-small{font-size:.82rem;padding:6px 10px}

    .search-bar{background:var(--card-bg);padding:12px 16px;box-shadow:var(--shadow);margin-top:12px;border-radius:var(--radius-lg);border:1px solid var(--border)}
    .search-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search-tabs{display:flex;gap:6px}
    .tab-button{padding:7px 12px;border:1px solid var(--border);background:none;color:var(--text-muted);font-size:.86rem;font-weight:700;cursor:pointer;border-radius:var(--radius-md);transition:.2s}
    .tab-button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .tab-button:hover:not(.active){background:#f8fafc}
    .search-input{flex:1;padding:9px 12px;font-size:.95rem;border:1px solid var(--border);border-radius:var(--radius-md);min-width:200px}
    .search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px hsla(var(--primary-hue),83%,53%,.2)}

    /* Dashboard layout */
    .dashboard{margin-top:12px;display:none}
    .dashboard.active{display:flex;flex-direction:column;height:calc(100vh - 210px);min-height:540px}
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:12px}
    .stat-card{background:var(--card-bg);border:1px solid var(--border);color:var(--text);padding:14px;border-radius:var(--radius-lg);text-align:left;transition:.2s}
    .stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .stat-number{font-size:1.6rem;font-weight:800;margin-bottom:2px;color:var(--primary);display:flex;align-items:center;gap:8px}
    .stat-label{font-size:.78rem;color:var(--text-muted)}

    .city-filters-container{display:none;background:var(--card-bg);padding:12px;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:12px}
    .filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .filter-title{font-size:.86rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;font-weight:800;margin-bottom:0}
    .city-btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .city-btn{padding:7px 12px;background:#fff;border:1px solid var(--border);border-radius:var(--radius-md);cursor:pointer;transition:.2s;font-size:.82rem;display:flex;flex-direction:column;align-items:center}
    .city-btn:hover{border-color:var(--primary);background:var(--bg)}
    .city-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .city-count{font-weight:800;font-size:1rem}
    .city-name{font-size:.72rem;opacity:.9}

    .content-grid{flex:1;min-height:0;display:grid;grid-template-columns:350px 1fr;gap:16px;margin-bottom:16px}
    .network-panel{background:var(--card-bg);border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;border:1px solid var(--border);min-height:0}
    .panel-header-flex{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .notice-inline{font-size:.8rem;font-weight:700;color:var(--text-muted);background:var(--bg);padding:3px 8px;border-radius:var(--radius-md)}
    .entity-group{min-height:0}
    #principals-group{flex:1;min-height:0;overflow-y:auto;padding-right:8px;margin-bottom:10px}
    #businesses-group{flex:2;min-height:0;overflow-y:auto;padding-right:8px;border-top:1px solid var(--border);padding-top:10px}
    .entity-group h4{color:var(--text-muted);font-size:.85rem;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px;position:sticky;top:0;background:var(--card-bg);padding-bottom:4px;z-index:1}
    .entity-item{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:6px;transition:.2s;display:flex;align-items:center;justify-content:space-between}
    .entity-item:hover{border-color:var(--primary);background:#fff}
    .entity-item.active-filter{border-color:var(--primary);background:hsl(var(--primary-hue),83%,97%);box-shadow:var(--shadow)}
    .entity-filter-area{flex-grow:1;cursor:pointer;padding:9px}
    .entity-details-btn{cursor:pointer;padding:8px 10px;font-size:1.05rem;opacity:.6;transition:.2s;border-radius:var(--radius-md);align-items:center;border-left:1px solid var(--border);display:flex}
    .entity-details-btn:hover{opacity:1;background:#e2e8f0}
    .entity-name{font-weight:800;color:var(--text);font-size:.92rem}
    .entity-meta{color:var(--text-muted);font-size:.8rem;margin-top:2px}
    .entity-badges{margin-top:5px;display:flex;flex-wrap:wrap;gap:6px}
    .entity-badge{display:inline-block;background:hsl(var(--primary-hue),83%,95%);color:var(--primary-dark);padding:2px 8px;border-radius:12px;font-size:.72rem;font-weight:800}
    .property-badge{background:#8b5cf6;color:#fff}
    .status-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:.68rem;font-weight:800}
    .status-badge.active{background:hsl(var(--secondary-hue),72%,95%);color:hsl(var(--secondary-hue),72%,26%)}
    .status-badge.inactive{background:var(--text-muted);color:#fff}
    .status-badge.dissolved{background:var(--danger);color:#fff}
    .status-badge.forfeited{background:var(--warning);color:#fff}
    .status-badge.rejected{background:#6b7280;color:#fff}
    .status-badge.unknown{background:#d1d5db;color:#1f2937}
    .link-badge{background:#0ea5e9;color:#fff}

    /* --- ADDED FOR VISUALIZATION --- */
    .entity-item.highlight-source { 
      border-left: 4px solid #ec4899; /* Pink for the source */
      background: #fdf2f8;
    }
    .entity-item.highlight-target {
      border-left: 4px solid #8b5cf6; /* Purple for linked targets */
      background: #f5f3ff;
    }

    .table-panel{background:var(--card-bg);border-radius:var(--radius-lg);box-shadow:var(--shadow);border:1px solid var(--border);display:flex;flex-direction:column;min-height:0}
    .table-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
    .table-title{font-weight:800;color:var(--text);display:flex;align-items:center;gap:12px}
    .filter-status{font-size:.84rem;font-weight:800;background:var(--bg);padding:3px 6px;border-radius:var(--radius-md);border:1px solid var(--border);display:none}
    .filter-status button{margin-left:6px;background:none;border:none;color:var(--primary);cursor:pointer;font-weight:900;font-size:.8rem}
    .table-actions{display:flex;gap:8px}
    .filter-input{padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:.85rem}
    .table-container{flex:1;min-height:0;overflow:auto}
    .property-table{width:100%;border-collapse:collapse}
    .property-table thead{background:var(--bg);position:sticky;top:0;z-index:10}
    .property-table th{padding:10px;text-align:left;font-weight:800;color:var(--text-muted);border-bottom:2px solid var(--border);font-size:.8rem;cursor:pointer}
    .property-table th:hover{color:var(--primary)}
    .property-table td{padding:10px;border-bottom:1px solid var(--border);font-size:.88rem}
    .property-table .value-cell { font-size: 0.82rem; line-height: 1.4; }
    .property-table .value-cell span { display: block; }
    .property-table .value-cell .label { font-weight: 700; color: var(--text-muted); }
    .property-table tbody tr{cursor:pointer;transition:background .2s}
    .property-table tbody tr:hover{background:var(--bg)}
    .map-link{color:var(--primary);text-decoration:none;font-weight:800}

    .home-insights{margin-top:12px}
    .home-insights .toggle-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .toggle-btn{padding:7px 10px;border:1px solid var(--border);background:var(--card-bg);border-radius:var(--radius-md);cursor:pointer;font-weight:800;font-size:.85rem}
    .toggle-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .home-insights-card{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow)}
    .insight-item-group{background:#fff;border-radius:var(--radius-md);border:1px solid var(--border);margin-bottom:12px;overflow:hidden}
    .insight-title{font-weight:800;color:var(--primary);padding:10px 12px;background:var(--bg);border-bottom:1px solid var(--border)}
    .insight-item{display:flex;justify-content:space-between;gap:10px;padding:9px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:.2s;}
    .insight-details { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
    .insight-values { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .insight-value-badge { font-size: .7rem; font-weight: 700; padding: 2px 6px; border-radius: var(--radius-md); background: var(--bg); border: 1px solid var(--border); white-space: nowrap;}
    .insight-item:last-child{border-bottom:none}
    .insight-item:hover{background:hsl(var(--primary-hue),83%,97%);transform:translateX(3px)}
    .insight-name{font-weight:800}
    .insight-value{font-weight:800;color:var(--text-muted)}
    .badge{display:inline-flex;align-items:center;border-radius:999px;padding:4px 8px;font-size:.72rem;font-weight:800;white-space:nowrap;border:1px solid #c7d2fe;margin-left:6px;background:#eef2ff;color:#3730a3}
    .badge .sub-badge{margin-left:6px;padding:2px 6px;border-radius:999px;font-size:.64rem;font-weight:900;border:1px solid #d1d5db;background:#e5e7eb;color:#374151}
    .badge .sub-badge.out{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .badge .sub-badge.in{background:#e5e7eb;border-color:#d1d5db;color:#374151}

    .click-cue{display:inline-flex;align-items:center;gap:8px;font-size:.85rem;font-weight:800;color:#1e40af;background:#eff6ff;border:1px solid #bfdbfe;border-radius:999px;padding:6px 10px;margin:6px 0 10px 0;box-shadow:0 0 0 0 rgba(59,130,246,.4);animation:pulseCue 1.8s infinite}
    @keyframes pulseCue{0%{box-shadow:0 0 0 0 rgba(59,130,246,.4)} 70%{box-shadow:0 0 0 8px rgba(59,130,246,0)} 100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
    .get-started{display:flex;align-items:center;gap:10px;font-size:.9rem;font-weight:800;color:#334155;background:#ffffff;border:1px dashed var(--border);border-radius:12px;padding:10px 12px;margin:10px 0 12px 0;box-shadow:var(--shadow-sm)}
    .get-started .dot{width:8px;height:8px;border-radius:999px;background:#10b981;box-shadow:0 0 0 0 rgba(16,185,129,.5);animation:pulseDot 1.8s infinite}
    @keyframes pulseDot{0%{box-shadow:0 0 0 0 rgba(16,185,129,.5)} 70%{box-shadow:0 0 0 10px rgba(16,185,129,0)} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}

    .loader{display:none;text-align:center;padding:30px;background:var(--card-bg);border-radius:12px;margin-top:14px;box-shadow:var(--shadow)}
    .loader.active{display:block}
    .spinner{border:4px solid var(--border);border-top:4px solid var(--primary);border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .loader-text{color:var(--text-muted);font-size:1rem}
    .error-message{background:#fef2f2;border-left:4px solid var(--danger);padding:12px;margin:14px 0;border-radius:4px;color:#991b1b}
    .notice-message{background:#eff6ff;border-left:4px solid var(--primary);padding:12px;margin:0 0 14px 0;border-radius:4px;color:#1e40af}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:var(--radius-lg);max-width:900px;width:92%;max-height:82vh;display:flex;flex-direction:column;box-shadow:var(--shadow-lg)}
    .modal-header{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:1.1rem;font-weight:800}
    .modal-body{padding:16px;overflow:auto}
    .detail-section{margin-bottom:16px}
    .detail-section h4{color:var(--primary);margin-bottom:8px;font-size:.92rem}
    .detail-item{display:flex;padding:7px 0;border-bottom:1px solid var(--bg)}
    .detail-label{font-weight:700;color:var(--text-muted);min-width:140px;font-size:.86rem}
    .modal-badge-container{display:flex;flex-wrap:wrap;gap:8px;padding-top:8px;}
    .modal-badge{background:var(--bg);border:1px solid var(--border);padding:4px 10px;font-size:.8rem;font-weight:700;border-radius:var(--radius-md);cursor:pointer;transition:.2s}
    .modal-badge:hover{background:var(--primary);color:#fff;border-color:var(--primary)}

    .report-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2100;align-items:center;justify-content:center}
    .report-modal.active{display:flex}
    .report-modal-content{background:#fff;border-radius:var(--radius-lg);width:90%;max-width:1000px;height:80vh;display:flex;flex-direction:column;box-shadow:var(--shadow-lg)}
    .report-modal-header{padding:18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .report-modal-title{font-size:1.2rem;font-weight:800}
    .report-modal-actions{display:flex;gap:8px}
    .modal-btn{background:none;border:none;font-size:1.1rem;color:var(--text-muted);cursor:pointer;padding:5px 8px;border-radius:4px}
    .modal-btn:hover{background:var(--bg)}
    .report-modal-body{padding:18px;overflow-y:auto;flex:1}
    .minimized-report{position:fixed;bottom:18px;right:18px;background:var(--primary);color:#fff;padding:10px 16px;border-radius:var(--radius-md);box-shadow:var(--shadow-lg);cursor:pointer;display:none;z-index:2200}
    .minimized-report.active{display:block}

    .header-content{display:flex;justify-content:space-between;align-items:center}
    .header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}

    .principals-header-tabs{display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card-bg);padding-bottom:4px;z-index:1}
    .principals-header-tabs h4{margin-bottom:0}
    .principal-tabs{display:flex;gap:4px}
    .principal-tab-button{padding:3px 8px;font-size:.75rem;font-weight:700;border:1px solid var(--border);border-radius:var(--radius-md);background:none;cursor:pointer;transition:.2s;color:var(--text-muted)}
    .principal-tab-button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    
    .mobile-tabs{display:none}
    .mobile-search-sticky{display:none}

    @media (max-width:800px){
      .container { padding-left: 10px; padding-right: 10px; }
      .header-content{flex-direction:column;align-items:flex-start;gap:12px}
      .header-actions{flex-wrap:nowrap;width:auto;align-self:stretch}
      .header-actions .btn{flex-grow:1;padding:8px 12px;}

      .search-controls{
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .search-controls .search-tabs {
        grid-column: 1 / -1;
      }
      .search-controls .search-input {
        grid-column: 1 / -1;
      }
      .search-controls .btn {
        width: 100%;
        padding: 10px;
      }
      
      .dashboard.active{height:auto;min-height:auto}
      body.dashboard-active #search-bar { display: none; }
      body.dashboard-active .mobile-search-sticky { display: flex; }

      .mobile-search-sticky {
        position: sticky; bottom: 0; left: 0; right: 0;
        padding: 10px; background: rgba(241, 245, 249, 0.9);
        backdrop-filter: blur(5px);
        border-top: 1px solid var(--border);
        z-index: 1000; gap: 10px;
      }
      .mobile-search-sticky .search-input { min-width: 0; }
      .mobile-search-sticky .btn { padding: 9px 12px; }

      .mobile-tabs{
        display:flex; gap: 6px; margin-bottom: 12px;
        position: sticky; top: 0; background: var(--bg);
        padding: 8px 0; z-index: 999;
      }
      .mobile-tab-btn {
        flex: 1; padding: 10px; font-size: .85rem; font-weight: 700;
        text-align: center; background: var(--card-bg); color: var(--text-muted);
        border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer;
      }
      .mobile-tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
      
      .content-grid{ grid-template-columns:1fr; gap: 0; }
      .network-panel, .table-panel { display: none; }
      #network-panel.mobile-active, #table-panel.mobile-active { display: flex; }
      #principals-group, #businesses-group { display: none; }
      #principals-group.mobile-active, #businesses-group.mobile-active { display: block; }
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="header-content">
      <div>
        <h1 id="app-title" style="cursor:pointer" onclick="goHome()">üè† they own WHAT??</h1>
        <p>Connecticut Property Network Explorer</p>
      </div>
      <div class="header-actions">
        <button id="start-over-btn" class="btn btn-purple" onclick="goHome()" style="display:none;">‚Ü©Ô∏è Start Over</button>
        <button class="btn btn-pink" onclick="browseReports()">üìö Reports</button>
        <button class="btn btn-secondary" onclick="openAboutModal()">About</button>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <div class="search-bar" id="search-bar">
    <div class="search-controls">
      <div class="search-tabs">
        <button id="tab-business" class="tab-button active" onclick="switchTab('business')">Business</button>
        <button id="tab-owner" class="tab-button" onclick="switchTab('owner')">Owner</button>
        <button id="tab-address" class="tab-button" onclick="switchTab('address')">Address</button>
      </div>
      <input type="text" class="search-input" id="search-input" placeholder="Enter active business name..." onkeypress="handleEnterKey(event)"/>
      <button class="btn btn-primary" id="search-button" onclick="performSearch()">Search</button>
      <button class="btn btn-secondary" onclick="resetSearch(true)">Clear</button>
    </div>
  </div>

  <div class="loader" id="loader"><div class="spinner"></div><p class="loader-text" id="loader-text">Searching records...</p></div>
  <div id="error-container"></div>

  <div id="home-insights" class="home-insights" style="display:none;">
    <div class="home-insights-card">
      <div class="toggle-row" id="insights-toggle-row"></div>
      <div id="get-started-banner" class="get-started" role="status" aria-live="polite" style="display:none;">
        <span class="dot" aria-hidden="true"></span>
        <span><strong>Get started:</strong> click a <em>network</em> or use <em>search</em> to begin.</span>
      </div>
      <div id="click-cue" class="click-cue" style="display:none;"></div>
      <div id="insights-groups"></div>
    </div>
  </div>

  <div class="selection-section" id="selection-section" style="display:none;">
    <div class="selection-card" style="background:#fff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow);">
      <h2 id="selection-title" style="margin-bottom:8px;font-size:1.05rem;">Select an Entity</h2>
      <div id="selection-list"></div>
    </div>
  </div>

  <div class="dashboard" id="dashboard">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-number" id="total-properties">0</div><div class="stat-label">Properties Found</div></div>
      <div class="stat-card"><div class="stat-number" id="total-businesses">0</div><div class="stat-label">Unique Businesses</div></div>
      <div class="stat-card">
        <div class="stat-number" id="total-human-principals">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          <span>0</span>
        </div>
        <div class="stat-label">Human Principals</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-entity-principals">
           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"></rect><path d="M3 7h18"></path><path d="M16 11h-2"></path><path d="M16 15h-2"></path><path d="M10 11h-2"></path><path d="M10 15h-2"></path></svg>
          <span>0</span>
        </div>
        <div class="stat-label">Entity Principals</div>
      </div>
      <div class="stat-card"><div class="stat-number" id="total-value">$0</div><div class="stat-label">Total Assessed Value</div></div>
      <div class="stat-card"><div class="stat-number" id="total-appraised-value">$0</div><div class="stat-label">Total Appraised Value</div></div>
    </div>
    
    <div id="mobile-tabs-container" class="mobile-tabs"></div>

    <div class="city-filters-container" id="city-filters-container" style="display:none;">
      <div class="filter-header">
        <h4 class="filter-title">üèôÔ∏è Filter by City:</h4>
        <button id="ai-digest-btn" class="btn btn-primary btn-small" onclick="generateAiReport()" style="display:none;">üß† Generate AI Digest</button>
      </div>
      <div class="city-btn-row" id="city-filters"></div>
    </div>

    <div class="content-grid">
      <div class="network-panel" id="network-panel">
        <div class="panel-header-flex">
          <h3 style="font-size:1rem;">Network Entities</h3>
          <span id="network-notice-inline" class="notice-inline"></span>
        </div>

        <div class="entity-group" id="principals-group">
          <div class="principals-header-tabs">
            <h4>Principals</h4>
            <div class="principal-tabs">
              <button id="tab-human" class="principal-tab-button active" onclick="switchPrincipalTab('human')">Human</button>
              <button id="tab-entity" class="principal-tab-button" onclick="switchPrincipalTab('entity')">Entity</button>
            </div>
          </div>
          <div id="human-principals-list" class="principal-tab-content active" style="display: block;"></div>
          <div id="entity-principals-list" class="principal-tab-content" style="display: none;"></div>
        </div>

        <div class="entity-group" id="businesses-group">
          <h4>Businesses</h4>
          <div id="active-businesses-list"></div>
          <div class="collapsible-section" id="inactive-section" style="display:none;">
            <div class="collapsible-header" onclick="toggleInactive(this)" style="display:flex;justify-content:space-between;align-items:center;padding:7px 9px;background:#f8fafc;border:1px dashed var(--border);border-radius:8px;margin-top:8px;cursor:pointer;">
              <span id="inactive-count">0 Inactive Businesses</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="collapsible-content" id="inactive-businesses-list" style="overflow:hidden;"></div>
          </div>
        </div>
      </div>

      <div class="table-panel" id="table-panel">
        <div class="table-header">
          <div class="table-title">
            <span>Properties</span>
            <span id="entity-filter-status" class="filter-status"></span>
          </div>
          <div class="table-actions">
            <input type="text" class="filter-input" id="filter-input" placeholder="Filter table..." onkeyup="filterProperties()"/>
            <button class="btn btn-secondary" onclick="exportToCSV()" style="font-size:.8rem;padding:6px 10px;">Export CSV</button>
          </div>
        </div>
        <div class="table-container" id="table-container">
          <table class="property-table" id="property-table">
            <thead>
              <tr>
                <th onclick="sortTable(0)">Address ‚Üï</th>
                <th onclick="sortTable(1)">City ‚Üï</th>
                <th onclick="sortTable(2)">Owner ‚Üï</th>
                <th onclick="sortTable(3)">Assessed / Appraised Value ‚Üï</th>
                <th>Map</th>
              </tr>
            </thead>
            <tbody id="property-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="detail-modal" onclick="closeModalOnBackdrop(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h3 class="modal-title" id="modal-title">Details</h3>
        <p class="modal-subtitle" id="modal-subtitle"></p>
      </div>
      <button class="btn btn-secondary" style="padding:5px 10px;font-size:1.1rem" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<div class="modal" id="about-modal" onclick="closeModalOnBackdrop(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">About This Project</h3>
      <button class="btn btn-secondary" style="padding:5px 10px;font-size:1.1rem" onclick="closeAboutModal()">√ó</button>
    </div>
    <div class="modal-body" id="about-modal-body">
      <div class="detail-section">
        <h4>What it is</h4>
        <p>This tool maps relationships between Connecticut property owners, registered businesses, and their principals to reveal ownership networks and concentration patterns.</p>
      </div>

      <div class="detail-section">
        <h4>Data Sources</h4>
        <ul style="margin-left:20px;list-style:disc">
          <li style="margin:5px 0 5px 5px"><a href="https://data.ct.gov/Business/Connecticut-Business-Registry-Business-Master/n7gp-d28j/about_data" target="_blank" rel="noopener noreferrer">CT Business Registry ‚Äì Business Master</a></li>
          <li style="margin:5px 0 5px 5px"><a href="https://data.ct.gov/Business/Connecticut-Business-Registry-Principals/ka36-64k6/about_data" target="_blank" rel="noopener noreferrer">CT Business Registry ‚Äì Principals</a></li>
          <li style="margin:5px 0 5px 5px"><a href="https://data.ct.gov/Local-Government/2024-Connecticut-Parcel-and-CAMA-Data/pqrn-qghw/about_data" target="_blank" rel="noopener noreferrer">CT 2024 Parcel & CAMA</a></li>
          <li style="margin:5px 0 5px 5px">Supplemental municipal assessor pages (VGSI/QA) for filling gaps and updating records. (There's a lot left to do here.)</li>
          <li style="margin:5px 0 5px 5px">Coming soon: AI digest report based on property ownership data, a comprehensive analysis of ownership patterns and trends, a web search for recent developments or news, and more. Mind the bugginess.</li>
          <li style="margin:5px 0 5px 5px">Future enhancements: Improved entity resolution, additional data sources like code enforcement data (which I haven't found a good way to get ahold of yet), and more robust analytics to identify ownership patterns as they evolve, hopefully ultimately almost in real time. Who are these people buying our cities and leaving them in disrepair?</li>
        </ul>
      </div>

      <div class="detail-section">
        <h4>How it works</h4>
        <ul style="margin-left:20px;list-style:disc">
          <li style="margin:5px 0 5px 5px"><b>Normalization:</b> Standardizes business and principal names for robust matching.</li>
          <li style="margin:5px 0 5px 5px"><b>Linking:</b> Connects principals ‚Üî businesses ‚Üî properties.</li>
          <li style="margin:5px 0 5px 5px"><b>Pre-computed networks:</b> Back-end processes build ownership networks nightly.</li>
          <li style="margin:5px 0 5px 5px"><b>Caching:</b> Insights and reports are cached for speed.</li>
        </ul>
      </div>

      <div class="detail-section">
        <h4>Purpose & Disclaimer</h4>
        <p>This is an investigative/advocacy tool. While care is taken to ensure accuracy, users should verify critical findings with primary sources. No warranty is made as to timeliness or completeness.</p>
      </div>

      <div class="detail-section">
        <h4>Contact</h4>
        <p>Questions or feedback: <a href="mailto:salmunk@gmail.com">salmunk@gmail.com</a></p>
      </div>
    </div>
  </div>
</div>
<div class="mobile-search-sticky" id="mobile-search-sticky">
  <input type="text" class="search-input" id="mobile-search-input" placeholder="Search...">
  <button class="btn btn-primary" id="mobile-search-button">Search</button>
</div>

<script>
  // --- Global State ---
  let allProperties = [], allEntities = new Map(), allLinks = {};
  let currentSearchType = 'business', currentCityFilter = null, currentEntityFilter = null;
  let humanPrincipals = [], entityPrincipals = [];
  let insightsIndex = {}, activeInsightsKey = null;
  const INSIGHTS_CACHE_KEY = 'insights_cache_v2';
  const INSIGHTS_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

  // --- DOM Elements ---
  const DOM = {
    loader: document.getElementById('loader'),
    loaderText: document.getElementById('loader-text'),
    errorContainer: document.getElementById('error-container'),
    networkNoticeInline: document.getElementById('network-notice-inline'),

    selectionList: document.getElementById('selection-list'),
    selectionSection: document.getElementById('selection-section'),
    selectionTitle: document.getElementById('selection-title'),

    dashboard: document.getElementById('dashboard'),
    propertyTbody: document.getElementById('property-tbody'),
    activeBusinessesList: document.getElementById('active-businesses-list'),
    inactiveBusinessesList: document.getElementById('inactive-businesses-list'),
    inactiveSection: document.getElementById('inactive-section'),
    inactiveCount: document.getElementById('inactive-count'),
    
    totalProperties: document.getElementById('total-properties'),
    totalBusinesses: document.getElementById('total-businesses'),
    totalHumanPrincipals: document.querySelector('#total-human-principals span'),
    totalEntityPrincipals: document.querySelector('#total-entity-principals span'),
    totalValue: document.getElementById('total-value'),
    totalAppraisedValue: document.getElementById('total-appraised-value'),
    
    cityFiltersContainer: document.getElementById('city-filters-container'),
    cityFilters: document.getElementById('city-filters'),
    entityFilterStatus: document.getElementById('entity-filter-status'),
    aiDigestBtn: document.getElementById('ai-digest-btn'),

    mobileTabsContainer: document.getElementById('mobile-tabs-container'),
    networkPanel: document.getElementById('network-panel'),
    tablePanel: document.getElementById('table-panel'),
    principalsGroup: document.getElementById('principals-group'),
    businessesGroup: document.getElementById('businesses-group'),

    searchBar: document.getElementById('search-bar'),
    searchInput: document.getElementById('search-input'),
    
    homeInsights: document.getElementById('home-insights'),
    insightsToggleRow: document.getElementById('insights-toggle-row'),
    insightsGroups: document.getElementById('insights-groups'),
    
    startOverBtn: document.getElementById('start-over-btn'),
  };
  
  // --- Utils ---
  const formatCurrency = (v) => Number(v) ? '$' + Number(v).toLocaleString('en-US', { maximumFractionDigits: 0 }) : 'N/A';
  const formatValue = (key, value) => {
    if (value == null || (typeof value === 'string' && value.trim()==='')) return 'N/A';
    if (key.includes('value') || key.includes('amount')) return formatCurrency(value);
    if (key.includes('date')) { const d = new Date(value); return isNaN(d) ? value : d.toLocaleDateString(); }
    return value;
  };
   function normalizeForMatch(name){
    if(!name) return '';
    let n = name.toUpperCase().replace(/[,.'"`"&]/g,'').replace(/\s+/g,' ').trim();
    const suffixes = [' LLC',' L L C',' LLP',' L L P',' INC',' CORP',' LP',' LTD',' COMPANY',' PROPERTIES',' REALTY',' HOLDINGS',' MANAGEMENT'];
    for(const s of suffixes){ if(n.endsWith(s)){ n = n.slice(0, -s.length).trim(); break; } }
    return n;
  }
  async function apiRequest(endpoint, options = {}) {
    try {
        const r = await fetch(`/api/${endpoint}`, options);
        if (!r.ok) {
            let detail = `HTTP Error ${r.status}`;
            try { const data = await r.json(); detail = data.detail || detail; } catch (e) { /* ignore */ }
            throw new Error(detail);
        }
        if (r.status === 204) return null;
        return r.json();
    } catch (err) {
        showError(err.message);
        throw err;
    }
  }
  function showError(msg) {
    DOM.errorContainer.innerHTML = `<div class="error-message">${msg}</div>`;
    DOM.loader.style.display = 'none';
  }
  function showLoader(show, text = 'Loading...') {
    DOM.loader.style.display = show ? 'block' : 'none';
    if (show) DOM.loaderText.textContent = text;
  }
  
  // --- Insights ---
  function getCachedInsights() {
    try {
        const raw = localStorage.getItem(INSIGHTS_CACHE_KEY);
        if (!raw) return null;
        const { timestamp, reports } = JSON.parse(raw);
        if (Date.now() - timestamp > INSIGHTS_CACHE_TTL_MS) return null;
        return reports;
    } catch (e) { return null; }
  }
  function setCachedInsights(reports) {
    try { localStorage.setItem(INSIGHTS_CACHE_KEY, JSON.stringify({ timestamp: Date.now(), reports })); } catch (e) { /* ignore */ }
  }
  async function loadInsightsOnce() {
    const cached = getCachedInsights();
    if (cached) {
        insightsIndex = cached;
        return;
    }
    const reports = await apiRequest('insights');
    insightsIndex = reports || {};
    setCachedInsights(insightsIndex);
  }
  async function showHomeInsights() {
    try {
        showLoader(true, 'Fetching insights...');
        await loadInsightsOnce();
        activeInsightsKey = insightsIndex['STATEWIDE'] ? 'STATEWIDE' : Object.keys(insightsIndex)[0] || null;
        renderHomeInsightsToggles();
        renderHomeInsightsList();
        DOM.homeInsights.style.display = 'block';
    } catch (e) { /* Error shown by apiRequest */ } 
    finally { showLoader(false); }
  }
  function renderHomeInsightsToggles(){
    const keys = Object.keys(insightsIndex); if(!keys.length) return;
    const ordered = ['STATEWIDE', ...keys.filter(k => k !== 'STATEWIDE').sort()];
    DOM.insightsToggleRow.innerHTML = ordered.map(k => {
      const active = (k === activeInsightsKey) ? 'active' : '';
      const label = (k === 'STATEWIDE') ? 'Statewide' : k.split(' ').map(w => w[0] + w.slice(1).toLowerCase()).join(' ');
      return `<button class="toggle-btn ${active}" onclick="setInsightsScope('${k.replace(/'/g, "\\'")}')">${label}</button>`;
    }).join('');
  }
  function renderHomeInsightsList(){
    const group = insightsIndex[activeInsightsKey];
    if (!group || group.length === 0) {
      DOM.insightsGroups.innerHTML = `<div class="notice-message">No insights available for this area.</div>`;
      return;
    }
    const itemsHtml = group.map(item => {
        const safeId = (item.entity_id || '').replace(/'/g, "\\'");
        const safeName = (item.entity_name || '').replace(/'/g, "\\'");
        const safeType = (item.entity_type || '').replace(/'/g, "\\'");
        const displayName = item.entity_name || 'Unknown';
        const principalBadges = (item.principals && item.principals.length)
        ? item.principals.map(p=>{
            const state = (p.state || '').toUpperCase();
            const out = state && state !== 'CT';
            return `<span class="badge">${p.name}${state ? `<span class="sub-badge ${out ? 'out' : 'in'}">${state}</span>` : ''}</span>`;
          }).join(' ') : '';
        const assessedValue = item.total_assessed_value ? formatCurrency(item.total_assessed_value) : 'N/A';
        const appraisedValue = item.total_appraised_value ? formatCurrency(item.total_appraised_value) : 'N/A';

        return `<div class="insight-item" onclick="startNetworkLoad({id:'${safeId}',name:'${safeName}'}, '${safeType}')">
                    <div class="insight-details">
                        <span class="insight-name">${displayName}</span>
                        <div>${principalBadges}</div>
                    </div>
                    <div class="insight-values">
                        <span class="insight-value">${item.value} Properties</span>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px; margin-top: 4px;">
                            <span class="insight-value-badge"><span class="label">Assessed:</span> ${assessedValue}</span>
                            <span class="insight-value-badge"><span class="label">Appraised:</span> ${appraisedValue}</span>
                        </div>
                    </div>
                </div>`;
    }).join('');
    DOM.insightsGroups.innerHTML = `<div class="insight-item-group"><div class="insight-title">Top Networks: ${activeInsightsKey}</div>${itemsHtml}</div>`;
  }
  function setInsightsScope(key) {
    activeInsightsKey = key;
    renderHomeInsightsToggles();
    renderHomeInsightsList();
  }

  // --- Mobile View Management ---
  function setupMobileTabs() {
    const isMobile = window.matchMedia('(max-width: 800px)').matches;
    if (!isMobile) {
      DOM.mobileTabsContainer.innerHTML = '';
      DOM.networkPanel.style.display = 'flex';
      DOM.tablePanel.style.display = 'flex';
      DOM.principalsGroup.style.display = 'block';
      DOM.businessesGroup.style.display = 'block';
      DOM.networkPanel.classList.remove('mobile-active');
      DOM.tablePanel.classList.remove('mobile-active');
      return;
    }
    DOM.mobileTabsContainer.innerHTML = `
      <button class="mobile-tab-btn active" data-tab="principals">Principals</button>
      <button class="mobile-tab-btn" data-tab="businesses">Businesses</button>
      <button class="mobile-tab-btn" data-tab="properties">Properties</button>
    `;
    DOM.mobileTabsContainer.addEventListener('click', (e) => {
      if (e.target.matches('.mobile-tab-btn')) switchMobileTab(e.target.dataset.tab);
    });
    switchMobileTab('principals');
  }
  function switchMobileTab(tab) {
    document.querySelectorAll('.mobile-tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
    DOM.networkPanel.classList.toggle('mobile-active', tab === 'principals' || tab === 'businesses');
    DOM.tablePanel.classList.toggle('mobile-active', tab === 'properties');
    DOM.principalsGroup.style.display = (tab === 'principals') ? 'block' : 'none';
    DOM.businessesGroup.style.display = (tab === 'businesses') ? 'block' : 'none';
  }

  // --- Network Loading and Rendering ---
   async function startNetworkLoad(startEntity, startType) {
    document.body.classList.add('dashboard-active');
    DOM.searchBar.style.display = 'none';
    DOM.homeInsights.style.display = 'none';
    DOM.selectionSection.style.display = 'none'; // Hide selection list
    DOM.dashboard.classList.add('active');
    DOM.startOverBtn.style.display = 'inline-block'; // Show the button
    allEntities.clear(); allProperties = []; allLinks = {}; humanPrincipals = []; entityPrincipals = [];
    DOM.propertyTbody.innerHTML = '';
    showLoader(true, `Loading network for ${startEntity.name}...`);
    try {
      const response = await fetch('/api/network/stream_load', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ entity_id: startEntity.id, entity_type: startType, entity_name: startEntity.name })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ detail: `HTTP error! Status: ${response.status}` }));
        throw new Error(errorData.detail || 'Failed to load network data.');
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();
        for (const line of lines) {
          if (!line.trim()) continue;
          const chunk = JSON.parse(line);
          if (chunk.error) {
              throw new Error(`An error occurred while loading the network: ${chunk.error}`);
          }
          if (chunk.type === 'entities') {
            (chunk.data.entities || []).forEach(e => {
                const key = `${e.type}_${e.id}`;
                if (!allEntities.has(key)) allEntities.set(key, e);
            });
            allLinks = chunk.data.links || {};
          } else if (chunk.type === 'properties') {
            allProperties.push(...chunk.data);
          } else if (chunk.type === 'done') {
            renderAll();
            showLoader(false);
            return;
          }
        }
      }
      // If loop finishes without a 'done' chunk, render what we have
      renderAll();
      showLoader(false);

    } catch (e) {
      console.error("Failed to load network:", e);
      showError(e.message || "An unknown error occurred while loading the network.");
      showLoader(false);
    }
  }
  function renderAll() {
    categorizePrincipals();
    renderEntityLists();
    renderStats();
    appendPropertiesToTable(allProperties);
    setupMobileTabs();
    renderStatsAndBadges();
  }
  function categorizePrincipals() {
    const principals = Array.from(allEntities.values()).filter(e => e.type === 'principal');
    const allBusinesses = Array.from(allEntities.values()).filter(e => e.type === 'business');
    const businessNamesUpper = new Set(allBusinesses.map(b => (b.name || '').toUpperCase()));
    const entitySuffixes = /\b(LLC|L L C|INC|CORP|LTD|LP|LIMITED|COMPANY|PARTNERS|GROUP|HOLDINGS|REALTY|VENTURES)\b/;
    humanPrincipals = []; entityPrincipals = [];
    principals.forEach(p => {
      const upperName = (p.name || '').toUpperCase();
      if (businessNamesUpper.has(upperName) || entitySuffixes.test(upperName)) {
        entityPrincipals.push(p);
      } else {
        humanPrincipals.push(p);
      }
    });
  }
  function renderEntityLists() {
    const allBusinesses = Array.from(allEntities.values()).filter(e => e.type === 'business');
    const activeBiz = allBusinesses.filter(b => b.status && b.status.toUpperCase() === 'ACTIVE').sort((a,b)=>a.name.localeCompare(b.name));
    const inactiveBiz = allBusinesses.filter(b => !b.status || b.status.toUpperCase() !== 'ACTIVE').sort((a,b)=>a.name.localeCompare(b.name));
    
    const renderBusiness = (e) => {
      const statusClass = (e.status || 'unknown').toLowerCase();
      const meta = e.details?.business_address || e.details?.business_city || 'No address';
      const eDetails = JSON.stringify(e).replace(/'/g, "\\'");
      const safeId = String(e.id).replace(/'/g, "\\'");
      const key = `${e.type}_${e.id}`;
      return `<div class="entity-item" id="entity-dom-${key}">
                <div class="entity-filter-area" onclick="filterByEntity('${e.type}', '${safeId}')" title="Filter properties by this entity">
                  <div class="entity-name">${e.name}</div>
                  <div class="entity-meta">${meta}</div>
                  <div class="entity-badges">
                    <span class="status-badge ${statusClass}">${e.status || 'UNKNOWN'}</span>
                    <span class="entity-badge property-badge" id="propbadge-${e.type}-${e.id}" style="display:none;"></span>
                  </div>
                </div>
                <div class="entity-details-btn" onclick='showEntityDetails(${eDetails})' title="Show details">‚ÑπÔ∏è</div>
                <div class="entity-details-btn" onclick='traceConnections("${key}")' title="Trace connections">üîó</div>
              </div>`;
    };

    DOM.activeBusinessesList.innerHTML = activeBiz.map(renderBusiness).join('');
    DOM.inactiveSection.style.display = inactiveBiz.length > 0 ? 'block' : 'none';
    DOM.inactiveCount.textContent = `${inactiveBiz.length} Inactive`;
    DOM.inactiveBusinessesList.innerHTML = inactiveBiz.map(renderBusiness).join('');

    const principalLinkCounts = new Map();
    [...humanPrincipals, ...entityPrincipals].forEach(p => {
        const key = `principal_${p.id}`;
        const count = allLinks.principal_to_business?.filter(l => l.source === key).length || 0;
        principalLinkCounts.set(p.id, count);
    });
    const sortPrincipals = (a, b) => (principalLinkCounts.get(b.id) || 0) - (principalLinkCounts.get(a.id) || 0);
    humanPrincipals.sort(sortPrincipals);
    entityPrincipals.sort(sortPrincipals);
    
    const renderPrincipal = p => {
      const pDetails = JSON.stringify(p).replace(/'/g, "\\'");
      const safeId = String(p.id).replace(/'/g, "\\'");
      const key = `${p.type}_${p.id}`;
      const count = principalLinkCounts.get(p.id) || 0;
      const badge = count > 0 ? `<span class="entity-badge link-badge">${count} linked ${count === 1 ? 'business' : 'businesses'}</span>` : '';
      return `<div class="entity-item" id="entity-dom-${key}">
                <div class="entity-filter-area" onclick="filterByEntity('${p.type}', '${safeId}')" title="Filter properties by this entity">
                  <div class="entity-name">${p.name}</div>
                  <div class="entity-badges">${badge}</div>
                </div>
                <div class="entity-details-btn" onclick='showEntityDetails(${pDetails})' title="Show details">‚ÑπÔ∏è</div>
                <div class="entity-details-btn" onclick='traceConnections("${key}")' title="Trace connections">üîó</div>
              </div>`;
    };
    document.getElementById('human-principals-list').innerHTML = humanPrincipals.map(renderPrincipal).join('');
    document.getElementById('entity-principals-list').innerHTML = entityPrincipals.map(renderPrincipal).join('');
    document.getElementById('tab-human').textContent = `Human (${humanPrincipals.length})`;
    document.getElementById('tab-entity').textContent = `Entity (${entityPrincipals.length})`;
    if (humanPrincipals.length > 0) switchPrincipalTab('human'); else switchPrincipalTab('entity');
  }
  function renderStats() {
    DOM.totalProperties.textContent = allProperties.length.toLocaleString();
    DOM.totalBusinesses.textContent = Array.from(allEntities.values()).filter(e => e.type === 'business').length.toLocaleString();
    DOM.totalHumanPrincipals.textContent = humanPrincipals.length.toLocaleString();
    DOM.totalEntityPrincipals.textContent = entityPrincipals.length.toLocaleString();
    const totalValue = allProperties.reduce((s, p) => s + (Number(p.details?.assessed_value) || 0), 0);
    DOM.totalValue.textContent = formatCurrency(totalValue);
    const totalAppraised = allProperties.reduce((s, p) => s + (Number(p.details?.appraised_value) || 0), 0);
    DOM.totalAppraisedValue.textContent = formatCurrency(totalAppraised);
  }
   function renderStatsAndBadges(){
    const allBiz = Array.from(allEntities.values()).filter(e=>e.type==='business');
    const counts = new Map();
    for(const p of allProperties){
      if(p.owner){ const n = normalizeForMatch(p.owner); counts.set(n, (counts.get(n)||0)+1); }
    }
    allBiz.forEach(b=>{
      const n = normalizeForMatch(b.name); const c = counts.get(n)||0; b.propertyCount = c;
      if(c>0){ const badge = document.getElementById(`propbadge-${b.type}-${b.id}`); if(badge){ badge.textContent = `${c} ${c === 1 ? 'property' : 'properties'}`; badge.style.display='inline-block'; } }
    });

    const reSort = (container)=>{
      Array.from(container.children).sort((a,b)=>{
        const getC = (el)=>{ try{ const key = el.id.replace('entity-dom-',''); const biz = allEntities.get(key); return biz?.propertyCount || 0; }catch(_) {return 0;} };
        return getC(b) - getC(a);
      }).forEach(n=>container.appendChild(n));
    };
    reSort(DOM.activeBusinessesList); reSort(DOM.inactiveBusinessesList);
    renderStats(); // Update main stat cards
  }
  function appendPropertiesToTable(properties){
    const html = properties.map(p => {
      const mapQuery = `${p.address||''}, ${p.city||''}`;
      const assessed = formatCurrency(p.details?.assessed_value);
      const appraised = formatCurrency(p.details?.appraised_value);
      const propDetails = JSON.stringify(p.details || {}).replace(/'/g,"\\'");
      const safeOwner = (p.owner || '').replace(/'/g, "\\'");
      return `<tr onclick='highlightPropertyOwner("${safeOwner}", ${propDetails})'>
                <td>${p.address || 'N/A'}</td>
                <td>${p.city || 'N/A'}</td>
                <td>${p.owner || 'N/A'}</td>
                <td class="value-cell">
                    <span><span class="label">A:</span> ${assessed}</span>
                    <span><span class="label">B:</span> ${appraised}</span>
                </td>
                <td><a href="https://maps.google.com/maps?q=${encodeURIComponent(mapQuery)}" target="_blank" class="map-link" onclick="event.stopPropagation()">üó∫Ô∏è</a></td>
              </tr>`;
    }).join('');
    DOM.propertyTbody.innerHTML = html;
  }
  function switchPrincipalTab(tabName) {
    document.querySelectorAll('.principal-tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    document.querySelectorAll('.principal-tab-content').forEach(content => content.style.display = 'none');
    document.getElementById(`${tabName}-principals-list`).style.display = 'block';
  }

  // --- Filtering & Modals (Restored Interactive Logic) ---
  function filterByEntity(type, id){
    const key = `${type}_${id}`; currentEntityFilter = allEntities.get(key); if(!currentEntityFilter) return;
    document.querySelectorAll('.entity-item.active-filter').forEach(el=>el.classList.remove('active-filter'));
    const el = document.getElementById(`entity-dom-${key}`); if(el) el.classList.add('active-filter');
    DOM.entityFilterStatus.innerHTML = `Filtering by: <strong>${currentEntityFilter.name}</strong> <button onclick="clearEntityFilter(true)">Show All</button>`;
    DOM.entityFilterStatus.style.display='inline-block'; updatePropertyTable();
  }
  function clearEntityFilter(update=true){
    currentEntityFilter = null;
    document.querySelectorAll('.entity-item.active-filter').forEach(el=>el.classList.remove('active-filter'));
    DOM.entityFilterStatus.style.display='none'; if(update) updatePropertyTable();
  }
   function updatePropertyTable(){
    let rows = allProperties;
    if(currentCityFilter) rows = rows.filter(p=>p.city && p.city.toUpperCase()===currentCityFilter);
    if(currentEntityFilter){
      const ent = currentEntityFilter; const names = new Set([normalizeForMatch(ent.name)]);
      if(ent.type==='principal' && allLinks.principal_to_business){
        const eKey = `${ent.type}_${ent.id}`;
        allLinks.principal_to_business.forEach(l=>{ if(l.source===eKey){ const b = allEntities.get(l.target); if(b) names.add(normalizeForMatch(b.name)); }});
      }
      rows = rows.filter(p=>p.owner && names.has(normalizeForMatch(p.owner)));
    }
    appendPropertiesToTable(rows);
  }
  function showEntityDetails(entity){
    const modalTitle = document.getElementById('modal-title');
    const modalSubtitle = document.getElementById('modal-subtitle');
    const modalBody = document.getElementById('modal-body');

    modalTitle.textContent = entity.name;
    modalSubtitle.textContent = entity.type.charAt(0).toUpperCase()+entity.type.slice(1);
    
    let body = '<div class="detail-section"><h4>Details</h4>';
    if(entity.details && Object.keys(entity.details).length > 0){
      Object.entries(entity.details).forEach(([k,v])=>{
        const val = formatValue(k,v); if(val!=='N/A') body += `<div class="detail-item"><span class="detail-label">${k.replace(/_/g,' ')}:</span><span>${val}</span></div>`;
      });
    } else { body += `<p>No registry details available.</p>`; }
    body += '</div>';

    let connectionsHTML = '';
    if (entity.type === 'principal') {
        const principalKey = `principal_${entity.id}`;
        const relatedBusinesses = (allLinks.principal_to_business || [])
            .filter(link => link.source === principalKey)
            .map(link => allEntities.get(link.target))
            .filter(Boolean);

        if (relatedBusinesses.length > 0) {
            connectionsHTML = '<div class="detail-section"><h4>Associated Businesses</h4><div class="modal-badge-container">';
            relatedBusinesses.forEach(biz => {
                const bizDetails = JSON.stringify(biz).replace(/'/g, "\\'");
                connectionsHTML += `<button class="modal-badge" onclick='showEntityDetails(${bizDetails})'>${biz.name}</button>`;
            });
            connectionsHTML += '</div></div>';
        }
    } else if (entity.type === 'business') {
        const businessKey = `business_${entity.id}`;
        const relatedPrincipals = (allLinks.business_to_principal || [])
            .filter(link => link.source === businessKey)
            .map(link => allEntities.get(link.target))
            .filter(Boolean);

        if (relatedPrincipals.length > 0) {
            connectionsHTML = '<div class="detail-section"><h4>Associated Principals</h4><div class="modal-badge-container">';
            relatedPrincipals.forEach(p => {
                const pDetails = JSON.stringify(p).replace(/'/g, "\\'");
                connectionsHTML += `<button class="modal-badge" onclick='showEntityDetails(${pDetails})'>${p.name}</button>`;
            });
            connectionsHTML += '</div></div>';
        }
    }
    
    modalBody.innerHTML = body + connectionsHTML;
    document.getElementById('detail-modal').classList.add('active');
  }
  function showPropertyDetails(details){
    document.getElementById('modal-title').textContent = details.location || 'Property Details';
    document.getElementById('modal-subtitle').textContent = details.property_city || '';
    let body = '<div class="detail-section"><h4>Details</h4>';
    Object.entries(details).forEach(([k,v])=>{
      const val = formatValue(k,v); if(val!=='N/A') body += `<div class="detail-item"><span class="detail-label">${k.replace(/_/g,' ')}:</span><span>${val}</span></div>`;
    });
    document.getElementById('modal-body').innerHTML = body + '</div>';
    document.getElementById('detail-modal').classList.add('active');
  }
  function closeModal(){ document.getElementById('detail-modal').classList.remove('active'); }
  function openAboutModal() { document.getElementById('about-modal').classList.add('active'); }
  function closeAboutModal() { document.getElementById('about-modal').classList.remove('active'); }
  function closeModalOnBackdrop(e){ if(e.target.classList.contains('modal')){ e.target.classList.remove('active'); } }

  // --- NEW VISUALIZATION FUNCTIONS ---
  function traceConnections(sourceKey) {
    document.querySelectorAll('.entity-item').forEach(el => {
      el.classList.remove('highlight-source', 'highlight-target');
    });
    const sourceElement = document.getElementById(`entity-dom-${sourceKey}`);
    if (!sourceElement) return;
    sourceElement.classList.add('highlight-source');
    sourceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const entity = allEntities.get(sourceKey);
    const linksToTrace = entity.type === 'business' 
      ? allLinks.business_to_principal 
      : allLinks.principal_to_business;
    if (linksToTrace) {
      linksToTrace.forEach(link => {
        if (link.source === sourceKey) {
          const targetElement = document.getElementById(`entity-dom-${link.target}`);
          if (targetElement) {
            targetElement.classList.add('highlight-target');
          }
        }
      });
    }
  }

  function highlightPropertyOwner(ownerName, propertyDetails) {
    showPropertyDetails(propertyDetails);
    document.querySelectorAll('.entity-item').forEach(el => {
      el.classList.remove('highlight-source', 'highlight-target');
    });
    const normalizedOwner = normalizeForMatch(ownerName);
    for (const [key, entity] of allEntities.entries()) {
      if (normalizeForMatch(entity.name) === normalizedOwner) {
        const ownerElement = document.getElementById(`entity-dom-${key}`);
        if (ownerElement) {
          ownerElement.classList.add('highlight-source');
          ownerElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          break;
        }
      }
    }
  }

  // --- Search and Navigation ---
  async function performSearch() {
    const term = DOM.searchInput.value || document.getElementById('mobile-search-input').value;
    if (term.length < 3) return showError("Search term must be at least 3 characters.");
    DOM.homeInsights.style.display = 'none';
    DOM.selectionSection.style.display = 'none';
    const results = await apiRequest(`search?type=${currentSearchType}&term=${encodeURIComponent(term)}`);
    if (results && results.length > 0) {
      if (results.length === 1) {
        startNetworkLoad(results[0], results[0].type);
      } else {
        displaySelection(results);
      }
    } else {
      showError("No results found.");
    }
  }
  function displaySelection(results){
    DOM.selectionTitle.textContent = `Found ${results.length} results. Please select one:`;
    DOM.selectionList.innerHTML = results.map(item=>{
      const safeId = String(item.id).replace(/'/g, "\\'");
      let displayName = item.name;
      let entityNameToLoad = item.name;
      let contextText = item.context;

      if (currentSearchType === 'address' && item.context && item.context.startsWith('Owner: ')) {
        entityNameToLoad = item.context.substring('Owner: '.length);
        displayName = entityNameToLoad;
        contextText = item.name;
      }
      
      const safeNameToLoad = String(entityNameToLoad).replace(/'/g, "\\'");
      const contextHTML = contextText ? `<div style="color:var(--text-muted);font-size:.9rem">${contextText}</div>` : '';
      
      return `<div class="insight-item" onclick="startNetworkLoad({id:'${safeId}',name:'${safeNameToLoad}'}, '${item.type}')">
                <div style="font-weight:800">${displayName}</div>
                ${contextHTML}
              </div>`;
    }).join('');
    DOM.selectionSection.style.display = 'block';
  }
  function switchTab(type) {
    currentSearchType = type;
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${type}`).classList.add('active');
  }
  function resetSearch(clearInput=false){
    if (clearInput) {
        DOM.searchInput.value = '';
        document.getElementById('mobile-search-input').value = '';
    }
    DOM.selectionSection.style.display = 'none';
    document.body.classList.remove('dashboard-active');
    DOM.dashboard.classList.remove('active');
  }
  function goHome() {
    resetSearch(true);
    DOM.searchBar.style.display = 'block';
    DOM.startOverBtn.style.display = 'none'; // Hide the button
    showHomeInsights();
  }

  // --- Init ---
  window.addEventListener('resize', setupMobileTabs);
  document.addEventListener('DOMContentLoaded', () => {
    const mobileSearchInput = document.getElementById('mobile-search-input');
    const mobileSearchButton = document.getElementById('mobile-search-button');
    DOM.searchInput.addEventListener('input', () => { mobileSearchInput.value = DOM.searchInput.value; });
    mobileSearchInput.addEventListener('input', () => { DOM.searchInput.value = mobileSearchInput.value; });
    mobileSearchInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') performSearch(); });
    mobileSearchButton.addEventListener('click', performSearch);
    
    showHomeInsights();
  });
</script>
</body>
</html>