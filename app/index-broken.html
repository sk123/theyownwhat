<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>they own WHAT??</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>

        :root {

            --primary-hue: 221;

            --primary: hsl(var(--primary-hue), 83%, 53%);

            --primary-dark: hsl(var(--primary-hue), 83%, 43%);

            --secondary-hue: 162;

            --secondary: hsl(var(--secondary-hue), 72%, 46%);

            --danger: #ef4444; --warning: #f59e0b; --bg: #f1f5f9;

            --card-bg: #ffffff; --text: #0f172a; --text-muted: #64748b;

            --border: #e2e8f0; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);

            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);

            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

            --radius-md: 0.375rem; --radius-lg: 0.5rem;

        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        header { background: var(--card-bg); box-shadow: var(--shadow); padding: 15px 0; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }

        header .header-content { display: flex; justify-content: space-between; align-items: center; }

        header h1 { font-size: 1.5rem; color: var(--text); font-weight: 700; }

        header p { color: var(--text-muted); font-size: 0.9rem; margin: 0; }

        .search-bar { background: var(--card-bg); padding: 15px 20px; box-shadow: var(--shadow); margin-top: 15px; border-radius: var(--radius-lg); border: 1px solid var(--border); }

        .search-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

        .search-tabs { display: flex; gap: 6px; }

        .tab-button { padding: 8px 16px; background: none; border: 1px solid var(--border); color: var(--text-muted); font-size: 0.9rem; font-weight: 500; cursor: pointer; border-radius: var(--radius-md); transition: all 0.2s; white-space: nowrap; }

        .tab-button.active { background: var(--primary); color: white; border-color: var(--primary); }

        .tab-button:hover:not(.active) { background: #f8fafc; }

        .search-input { flex: 1; padding: 10px 14px; font-size: 1rem; border: 1px solid var(--border); border-radius: var(--radius-md); transition: all 0.3s; min-width: 200px; }

        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px hsla(var(--primary-hue), 83%, 53%, 0.2); }

        .btn { padding: 10px 20px; font-size: 0.95rem; font-weight: 600; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; white-space: nowrap; }

        .btn-primary { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }

        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }

        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }

        .btn-secondary:hover { background: var(--bg); }

        .btn-purple { background-color: #8b5cf6; color: white; } .btn-purple:hover { background-color: #7c3aed; }

        .dashboard { margin-top: 20px; display: none; } .dashboard.active { display: block; }

        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }

        .stat-card { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); padding: 20px; border-radius: var(--radius-lg); text-align: left; transition: transform 0.2s, box-shadow 0.2s; }

        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .stat-number { font-size: 2.2rem; font-weight: 700; margin-bottom: 2px; color: var(--primary); }

        .stat-label { font-size: 0.85rem; color: var(--text-muted); }

        .city-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border); }

        .content-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-bottom: 20px; }

        .network-panel { background: var(--card-bg); border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow); max-height: 600px; display: flex; flex-direction: column; border: 1px solid var(--border); }

        .network-panel h3 { color: var(--text); margin-bottom: 15px; font-size: 1.1rem; }

        .entity-group { margin-bottom: 0; }

        #businesses-group { flex: 2; min-height: 0; overflow-y: auto; padding-right: 10px; }

        #principals-group { flex: 1; min-height: 0; overflow-y: auto; padding-right: 10px; border-top: 1px solid var(--border); margin-top: 15px; padding-top: 15px; }

        .entity-group h4 { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; background: var(--card-bg); padding-bottom: 5px; z-index: 1; }

        .entity-item { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }

        .entity-item:hover { border-color: var(--primary); background: white; transform: translateX(3px); }

        .entity-name { font-weight: 600; color: var(--text); font-size: 0.95rem; }

        .entity-meta { color: var(--text-muted); font-size: 0.85rem; margin-top: 2px; }

        .entity-badges { margin-top: 5px; display: flex; flex-wrap: wrap; gap: 6px; }

        .entity-badge { display: inline-block; background: hsl(var(--primary-hue), 83%, 95%); color: var(--primary-dark); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }

        .status-badge.active { background: hsl(var(--secondary-hue), 72%, 95%); color: hsl(var(--secondary-hue), 72%, 26%); }

        .table-panel { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }

        .table-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}

        .table-container { max-height: 500px; overflow-y: auto; }

        .property-table { width: 100%; border-collapse: collapse; } .property-table thead { background: var(--bg); position: sticky; top: 0; z-index: 10; }

        .property-table th { padding: 12px; text-align: left; font-weight: 600; color: var(--text-muted); border-bottom: 2px solid var(--border); font-size: 0.85rem; cursor: pointer; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; } .modal.active { display: flex; }

        .modal-content { background: white; border-radius: var(--radius-lg); max-width: 800px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }

        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; } .modal-title { font-size: 1.2rem; font-weight: 600; } .modal-body { padding: 20px; overflow-y: auto; }

        .selection-section.active { display: block; } .selection-card { background: var(--card-bg); border-radius: var(--radius-lg); padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); }

        .selection-item { padding: 15px; margin-bottom: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s; }

        .selection-item:hover { border-color: var(--primary); background: hsl(var(--primary-hue), 83%, 97%); transform: translateY(-2px); box-shadow: var(--shadow); }

        .selection-item-title { font-weight: 600; } .selection-item-subtitle { color: var(--text-muted); font-size: 0.9rem; }

        .loader.active { display: block; } .spinner { border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-message { background: #fef2f2; border-left: 4px solid var(--danger); padding: 15px; margin: 20px 0; border-radius: 4px; color: #991b1b; }

        .notice-message { background: #eff6ff; border-left: 4px solid var(--primary); padding: 15px; margin: 0 0 20px 0; border-radius: 4px; color: #1e40af; }

        .collapsible-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px; }

        .collapsible-header { cursor: pointer; padding: 8px 12px; background: var(--bg); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); transition: all 0.2s; }

        .collapsible-header:hover { background: #e2e8f0; }

        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }

        .collapsible-content.expanded { max-height: 500px; overflow-y: auto; margin-top: 10px; }

        .collapse-icon { transition: transform 0.3s; }

        .collapsible-header.expanded .collapse-icon { transform: rotate(180deg); }

    </style>

</head>

<body>

    <header>

        <div class="container header-content">

            <div>

                <h1>üè† they own WHAT??</h1>

                <p>Connecticut Property Network Explorer</p>

            </div>

            <div class="header-actions">

                <button class="btn btn-secondary" onclick="openAboutModal()">About / Contact</button>

            </div>

        </div>

    </header>

    <div class="container">

        <div class="search-bar">

            <div class="search-controls">

                <div class="search-tabs">

                    <button id="tab-business" class="tab-button active" onclick="switchTab('business')">Business</button>

                    <button id="tab-owner" class="tab-button" onclick="switchTab('owner')">Owner</button>

                    <button id="tab-address" class="tab-button" onclick="switchTab('address')">Address</button>

                    <button id="show-insights-btn" class="tab-button btn-purple" onclick="showInsights()">üìä Show Insights</button>

                </div>

                <input type="text" class="search-input" id="search-input" placeholder="Enter active business name..." onkeypress="handleEnterKey(event)">

                <button class="btn btn-primary" id="search-button" onclick="performSearch()">Search</button>

                <button class="btn btn-secondary" onclick="resetSearch(true)">Clear</button>

            </div>

        </div>

        <div class="loader" id="loader"><div class="spinner"></div><p class="loader-text" id="loader-text">Searching records...</p></div>

        <div id="error-container"></div>

        <div class="selection-section" id="selection-section"><div class="selection-card"><h2 id="selection-title">Select a Business</h2><div id="selection-list"></div></div></div>

        <div class="dashboard" id="dashboard">

            <div id="notice-container"></div>

            <div class="stats-row">

                <div class="stat-card"><div class="stat-number" id="total-properties">0</div><div class="stat-label">Properties Found</div></div>

                <div class="stat-card"><div class="stat-number" id="total-businesses">0</div><div class="stat-label">Unique Businesses</div></div>

                <div class="stat-card"><div class="stat-number" id="total-principals">0</div><div class="stat-label">Principals Found</div></div>

                <div class="stat-card"><div class="stat-number" id="total-value">$0</div><div class="stat-label">Total Assessed Value</div></div>

                <div class="stat-card"><div class="stat-number" id="total-appraised-value">$0</div><div class="stat-label">Total Appraised Value</div></div>

            </div>

            

            <div class="report-controls" style="display:flex; justify-content: center; margin-bottom: 20px;">

                <button class="btn btn-primary" onclick="generateAiReport()">üß† Generate AI Digest</button>

            </div>

            

            <div class="city-filters" id="city-filters" style="display: none;"></div>

            

            <div class="content-grid">

                <div class="network-panel" id="network-panel">

                    <h3>Network Entities</h3>

                    <div class="entity-group" id="businesses-group">

                        <h4>Businesses</h4>

                        <div id="active-businesses-list"></div>

                        <div class="collapsible-section" id="inactive-section" style="display: none;">

                            <div class="collapsible-header" onclick="toggleInactive(this)">

                                <span id="inactive-count">0 Inactive Businesses</span><span class="collapse-icon">‚ñº</span>

                            </div>

                            <div class="collapsible-content" id="inactive-businesses-list"></div>

                        </div>

                    </div>

                    <div class="entity-group" id="principals-group">

                        <h4>Principals</h4>

                        <div id="principals-list"></div>

                    </div>

                </div>

                <div class="table-panel">

                    <div class="table-header">

                        <div class="table-title">Properties</div>

                        <div class="table-actions">

                            <input type="text" class="filter-input" id="filter-input" placeholder="Filter table..." onkeyup="filterProperties()">

                            <button class="btn btn-secondary" onclick="exportToCSV()" style="font-size: 0.85rem; padding: 6px 12px;">Export CSV</button>

                        </div>

                    </div>

                    <div class="table-container"><table class="property-table" id="property-table"><thead><tr><th onclick="sortTable(0)">Address ‚Üï</th><th onclick="sortTable(1)">City ‚Üï</th><th onclick="sortTable(2)">Owner ‚Üï</th><th onclick="sortTable(3)">Value ‚Üï</th><th>Map</th></tr></thead><tbody id="property-tbody"></tbody></table></div>

                </div>

            </div>

        </div>

    </div>

    

    <div class="modal" id="detail-modal" onclick="closeModalOnBackdrop(event)">

        <div class="modal-content" onclick="event.stopPropagation()">

            <div class="modal-header">

                <div>

                    <h3 class="modal-title" id="modal-title">Details</h3>

                    <p class="modal-subtitle" id="modal-subtitle"></p>

                </div>

                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 1.2rem;" onclick="closeModal()">√ó</button>

            </div>

            <div class="modal-body" id="modal-body"></div>

        </div>

    </div>

    <div class="modal" id="about-modal" onclick="closeModalOnBackdrop(event)">

        <div class="modal-content" onclick="event.stopPropagation()">

            <div class="modal-header">

                <h3 class="modal-title">About This Project</h3>

                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 1.2rem;" onclick="closeAboutModal()">√ó</button>

            </div>

            <div class="modal-body" id="about-modal-body">

                 <h4>How It Works</h4>

                <p>The network mapping is generated through an automated backend process:</p>

                <ul>

                    <li>The `discover_networks.py` script first robustly links properties to businesses and principals.</li>

                    <li>It then builds a relationship graph starting *only* from these property-owning entities and their direct connections, filtering out common "supernode" agents.</li>

                    <li>This clean, property-centric graph is used to discover and store the final networks.</li>

                </ul>

                 <h4>Purpose & Disclaimer</h4>

                <p>This tool was developed by Salmun Kazerounian to empower the public with accessible data. No guarantee is made regarding the timeliness or complete accuracy of the data. Users should verify findings with primary sources.</p>

                <h4>Contact</h4>

                <p>For questions or feedback, please contact Salmun Kazerounian at <a href="mailto:salmunk@gmail.com">salmunk@gmail.com</a>.</p>

            </div>

        </div>

    </div>

    

<script>

    let allProperties = [], allEntities = new Map(), currentSearchType = 'business';

    const DOMElements = {

        loader: document.getElementById('loader'), loaderText: document.getElementById('loader-text'),

        errorContainer: document.getElementById('error-container'), noticeContainer: document.getElementById('notice-container'),

        selectionSection: document.getElementById('selection-section'), selectionTitle: document.getElementById('selection-title'), 

        selectionList: document.getElementById('selection-list'), dashboard: document.getElementById('dashboard'), 

        propertyTbody: document.getElementById('property-tbody'), activeBusinessesList: document.getElementById('active-businesses-list'),

        inactiveBusinessesList: document.getElementById('inactive-businesses-list'), inactiveSection: document.getElementById('inactive-section'),

        inactiveCount: document.getElementById('inactive-count'), principalsList: document.getElementById('principals-list'), 

        totalProperties: document.getElementById('total-properties'), totalBusinesses: document.getElementById('total-businesses'), 

        totalPrincipals: document.getElementById('total-principals'), totalValue: document.getElementById('total-value'),

        totalAppraisedValue: document.getElementById('total-appraised-value'), cityFilters: document.getElementById('city-filters'),

        detailModal: document.getElementById('detail-modal'), aboutModal: document.getElementById('about-modal'),

        modalTitle: document.getElementById('modal-title'), modalSubtitle: document.getElementById('modal-subtitle'),

        modalBody: document.getElementById('modal-body'), searchInput: document.getElementById('search-input'),

        filterInput: document.getElementById('filter-input')

    };

    

    const formatCurrency = (v) => Number(v) ? '$' + Number(v).toLocaleString('en-US', { maximumFractionDigits: 0 }) : 'N/A';

    

    async function apiRequest(endpoint, options = {}) {

        try {

            const response = await fetch(`/api/${endpoint}`, options);

            if (!response.ok) {

                const errorData = await response.json().catch(() => ({ detail: `HTTP error! ${response.status}` }));

                throw new Error(errorData.detail);

            }

            if (response.status === 204) return null;

            return response.json();

        } catch (error) {

            showError(`API Request Failed: ${error.message}`);

            console.error(`API request failed for /api/${endpoint}:`, error);

            throw error;

        }

    }

    

    async function performSearch() {

        const term = DOMElements.searchInput.value.trim();

        if (term.length < 3) return showError("Please enter at least 3 characters.");

        resetSearch(false);

        showLoader(true, 'Searching for matching entities...');

        try {

            const results = await apiRequest(`search?type=${currentSearchType}&term=${encodeURIComponent(term)}`);

            if (!results || results.length === 0) return showError("No results found.");

            displaySelection(results);

        } catch (error) {

            // Error is already shown by apiRequest

        } finally {

            showLoader(false);

        }

    }



    function displaySelection(results) {

        DOMElements.selectionTitle.textContent = `Found ${results.length} results. Please select one:`;

        DOMElements.selectionList.innerHTML = results.map(item => {

            const safeId = String(item.id).replace(/'/g, "\\'");

            const safeName = String(item.name).replace(/'/g, "\\'");

            const contextHTML = item.context ? `<div class="selection-item-subtitle">${item.context}</div>` : '';

            const networkBadge = item.network_id ? `<span class="entity-badge" style="background: #6d28d9; color: white; margin-top: 5px;">Part of Network #${item.network_id}</span>` : '';



            return `<div class="selection-item" onclick="startNetworkLoad({id: '${safeId}', name: '${safeName}'}, '${item.type}')">

                <div class="selection-item-title">${item.name}</div>

                ${contextHTML}

                ${networkBadge}

            </div>`;

        }).join('');

        DOMElements.selectionSection.classList.add('active');

    }



    async function startNetworkLoad(startEntity, startType) {

        resetSearch(false);

        showLoader(true, `Loading network entities for ${startEntity.name}...`);

        DOMElements.dashboard.classList.add('active');

        allEntities.clear(); allProperties = []; DOMElements.propertyTbody.innerHTML = ''; 



        try {

            const response = await fetch('/api/network/stream_load', {

                method: 'POST',

                headers: { 'Content-Type': 'application/json' },

                body: JSON.stringify({ entity_id: startEntity.id, entity_type: startType, entity_name: startEntity.name })

            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            

            const reader = response.body.getReader();

            const decoder = new TextDecoder();

            let buffer = '';



            while (true) {

                const { value, done } = await reader.read();

                if (done) break;

                buffer += decoder.decode(value, { stream: true });

                const lines = buffer.split('\n');

                buffer = lines.pop();

                for (const line of lines) {

                    if (line.trim() === '') continue;

                    try {

                        const chunk = JSON.parse(line);

                        if (chunk.type === 'entities') {

                            showLoader(true, `Loading properties...`);

                            processEntityChunk(chunk.data.entities);

                            renderEntityLists();

                        } else if (chunk.type === 'properties') {

                            allProperties.push(...chunk.data);

                            appendPropertiesToTable(chunk.data);

                            showLoader(true, `Loading properties... (${allProperties.length} found)`);

                        } else if (chunk.type === 'done') {

                            showLoader(false);

                            renderStatsAndBadges();

                            updateCityFilters();

                            return;

                        } else if (chunk.type === 'error') {

                            throw new Error(chunk.data);

                        }

                    } catch (e) { console.error('Error parsing stream chunk:', e, 'Chunk:', line); }

                }

            }

        } catch (error) {

            showError(`Failed to load network: ${error.message}`);

            showLoader(false);

        }

    }

    

    function processEntityChunk(entities) {

        (entities || []).forEach(entity => {

            const key = `${entity.type}_${entity.id}`;

            if (!allEntities.has(key)) allEntities.set(key, entity);

        });

    }



    function appendPropertiesToTable(properties) {

        const html = properties.map(prop => {

            const mapQuery = `${prop.address || ''}, ${prop.city || ''}`;

            const assessed = formatCurrency(prop.details.assessed_value);

            const appraised = formatCurrency(prop.details.appraised_value);

            return `<tr onclick='showPropertyDetails(${JSON.stringify(prop.details)})'>

                <td>${prop.address || 'N/A'}</td>

                <td>${prop.city || 'N/A'}</td>

                <td>${prop.owner || 'N/A'}</td>

                <td>${assessed} / ${appraised}</td>

                <td><a href="https://maps.google.com/maps?q=${encodeURIComponent(mapQuery)}" 

                    target="_blank" onclick="event.stopPropagation()">üó∫Ô∏è</a></td>

            </tr>`;

        }).join('');

        DOMElements.propertyTbody.insertAdjacentHTML('beforeend', html);

    }

    

    function renderEntityLists() {

        const entities = Array.from(allEntities.values());

        const allBusinesses = entities.filter(e => e.type === 'business');

        const principals = entities.filter(e => e.type === 'principal');

        const activeBusinesses = allBusinesses.filter(b => b.status && b.status.toUpperCase() === 'ACTIVE');

        const inactiveBusinesses = allBusinesses.filter(b => !b.status || b.status.toUpperCase() !== 'ACTIVE');

        

        const renderBusiness = (entity) => {

            const statusClass = (entity.status || 'unknown').toLowerCase();

            const meta = entity.details?.business_address || entity.details?.business_city || 'No address';

            return `<div class="entity-item" onclick='showEntityDetails(${JSON.stringify(entity)})'>

                <div class="entity-name">${entity.name}</div>

                <div class="entity-meta">${meta}</div>

                <div class="entity-badges">

                    <span class="entity-badge status-badge ${statusClass}">${entity.status || 'UNKNOWN'}</span>

                    <span class="entity-badge property-badge" id="propbadge-${entity.type}-${entity.id}" style="display: none;"></span>

                </div>

            </div>`;

        };

        DOMElements.activeBusinessesList.innerHTML = activeBusinesses.map(renderBusiness).join('');

        if (inactiveBusinesses.length > 0) {

            DOMElements.inactiveSection.style.display = 'block';

            DOMElements.inactiveCount.textContent = `${inactiveBusinesses.length} Inactive`;

            DOMElements.inactiveBusinessesList.innerHTML = inactiveBusinesses.map(renderBusiness).join('');

        } else {

            DOMElements.inactiveSection.style.display = 'none';

        }

        DOMElements.principalsList.innerHTML = principals.map(entity => `

            <div class="entity-item" onclick='showEntityDetails(${JSON.stringify(entity)})'>

                <div class="entity-name">${entity.name}</div>

            </div>`).join('');

    }



    function renderStatsAndBadges() {

        const allBusinesses = Array.from(allEntities.values()).filter(e => e.type === 'business');

        allBusinesses.forEach(biz => {

            const count = allProperties.filter(p => p.owner && biz.name && p.owner.toUpperCase() === biz.name.toUpperCase()).length;

            if (count > 0) {

                const badge = document.getElementById(`propbadge-${biz.type}-${biz.id}`);

                if (badge) {

                    badge.textContent = `${count} properties`;

                    badge.style.display = 'inline-block';

                }

            }

        });

        const reSortBusinesses = (container) => {

             Array.from(container.children).sort((a, b) => {

                    const idA = a.querySelector('.property-badge')?.id.replace('propbadge-','');

                    const idB = b.querySelector('.property-badge')?.id.replace('propbadge-','');

                    if(!idA || !idB) return 0;

                    const bizA = allEntities.get(idA.replace(/-/g, '_'));

                    const bizB = allEntities.get(idB.replace(/-/g, '_'));

                    if(!bizA || !bizB) return 0;

                    const countA = allProperties.filter(p => p.owner && bizA.name && p.owner.toUpperCase() === bizA.name.toUpperCase()).length;

                    const countB = allProperties.filter(p => p.owner && bizB.name && p.owner.toUpperCase() === bizB.name.toUpperCase()).length;

                    return countB - countA;

                }).forEach(node => container.appendChild(node));

        };

        reSortBusinesses(DOMElements.activeBusinessesList);

        reSortBusinesses(DOMElements.inactiveBusinessesList);



        DOMElements.totalProperties.textContent = allProperties.length.toLocaleString();

        DOMElements.totalBusinesses.textContent = allBusinesses.length;

        DOMElements.totalPrincipals.textContent = Array.from(allEntities.values()).filter(e => e.type === 'principal').length.toLocaleString();

        const totalValue = allProperties.reduce((sum, p) => sum + (Number(p.details.assessed_value) || 0), 0);

        DOMElements.totalValue.textContent = formatCurrency(totalValue);

        const totalAppraisedValue = allProperties.reduce((sum, p) => sum + (Number(p.details.appraised_value) || 0), 0);

        DOMElements.totalAppraisedValue.textContent = formatCurrency(totalAppraisedValue);

    }

    

    function showEntityDetails(entity) {

        DOMElements.modalTitle.textContent = entity.name;

        DOMElements.modalSubtitle.textContent = entity.type.charAt(0).toUpperCase() + entity.type.slice(1);

        let body = '<div class="detail-section"><h4>Details</h4>';

        if (entity.details && Object.keys(entity.details).length > 0) {

            Object.entries(entity.details).forEach(([k, v]) => {

                const val = (k.includes('date') && v ? new Date(v).toLocaleDateString() : v) || 'N/A';

                if (val !== 'N/A') {

                    body += `<div class="detail-item"><span class="detail-label">${k.replace(/_/g, ' ')}:</span><span>${val}</span></div>`;

                }

            });

        } else { body += `<p>No registry details available.</p>`; }

        DOMElements.modalBody.innerHTML = body + '</div>';

        DOMElements.detailModal.classList.add('active');

    }



    function showPropertyDetails(details) {

        DOMElements.modalTitle.textContent = details.location || 'Property Details';

        DOMElements.modalSubtitle.textContent = details.property_city || '';

        let body = '<div class="detail-section"><h4>Details</h4>';

        Object.entries(details).forEach(([k, v]) => {

            const val = (k.includes('date') && v ? new Date(v).toLocaleDateString() : v) || 'N/A';

            if (val !== 'N/A') {

                body += `<div class="detail-item"><span class="detail-label">${k.replace(/_/g, ' ')}:</span><span>${val}</span></div>`;

            }

        });

        DOMElements.modalBody.innerHTML = body + '</div>';

        DOMElements.detailModal.classList.add('active');

    }

    

    function updateCityFilters() {

        const cityCounts = {};

        allProperties.forEach(prop => {

            const city = prop.city?.toUpperCase() || 'UNKNOWN';

            cityCounts[city] = (cityCounts[city] || 0) + 1;

        });

        const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

        let html = `<button class="btn btn-secondary" onclick="filterByCity(null, this)">All Cities (${allProperties.length})</button>`;

        sortedCities.forEach(([city, count]) => {

            const displayCity = city.split(' ').map(word => word.charAt(0) + word.slice(1).toLowerCase()).join(' ');

            html += `<button class="btn btn-secondary" onclick="filterByCity('${city}', this)">${displayCity} (${count})</button>`;

        });

        DOMElements.cityFilters.innerHTML = html;

        DOMElements.cityFilters.style.display = 'flex';

    }

    

    function filterByCity(city, btnElement) {

        document.querySelectorAll('#city-filters button').forEach(btn => btn.classList.remove('active'));

        if(btnElement) btnElement.classList.add('active');

        DOMElements.filterInput.value = city || '';

        filterProperties();

    }



    function toggleInactive(header) {

        header.classList.toggle('expanded');

        header.nextElementSibling.classList.toggle('expanded');

    }



    function sortTable(columnIndex) {

        const table = document.getElementById('property-table');

        const tbody = table.tBodies[0];

        const rows = Array.from(tbody.rows);

        const th = table.querySelectorAll('th')[columnIndex];

        const isAsc = !(th.dataset.sort === 'asc');

        rows.sort((a, b) => {

            let aText = a.cells[columnIndex].textContent.trim();

            let bText = b.cells[columnIndex].textContent.trim();

            if (columnIndex === 3) {

                const aVal = parseFloat(aText.split('/')[0].trim().replace(/[$,]/g, '')) || 0;

                const bVal = parseFloat(bText.split('/')[0].trim().replace(/[$,]/g, '')) || 0;

                return isAsc ? aVal - bVal : bVal - aVal;

            }

            return isAsc ? aText.localeCompare(bText) : bText.localeCompare(aText);

        });

        tbody.append(...rows);

        table.querySelectorAll('th').forEach(h => h.dataset.sort = '');

        th.dataset.sort = isAsc ? 'asc' : 'desc';

    }



    function filterProperties() {

        const filter = DOMElements.filterInput.value.toUpperCase();

        DOMElements.propertyTbody.querySelectorAll('tr').forEach(row => {

            row.style.display = row.textContent.toUpperCase().includes(filter) ? '' : 'none';

        });

    }



    function exportToCSV() {

        const headers = ['Address', 'City', 'Owner', 'Assessed Value', 'Appraised Value', 'Sale Amount', 'Sale Date'];

        let csv = headers.join(',') + '\n';

        allProperties.forEach(p => {

            const escape = (val) => `"${(val || '').toString().replace(/"/g, '""')}"`;

            const row = [

                p.address, p.city, p.owner, p.details.assessed_value, p.details.appraised_value,

                p.details.sale_amount, p.details.sale_date

            ].map(escape).join(',');

            csv += row + '\n';

        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');

        a.href = url;

        a.download = `property_network_export_${new Date().toISOString().slice(0,10)}.csv`;

        a.click();

        URL.revokeObjectURL(url);

    }

    

    function generateAiReport() {

        alert("AI Digest feature coming soon!");

    }

    

    async function showInsights() {

        resetSearch(false);

        showLoader(true, "Fetching statewide insights...");

        try {

            const reports = await apiRequest('reports');

            DOMElements.selectionTitle.textContent = 'Statewide Insights';

            if (reports.length === 0) {

                 DOMElements.selectionList.innerHTML = `<div class="notice-message" style="margin:0;">No insights found.</div>`;

            } else {

                DOMElements.selectionList.innerHTML = reports.map(report => {

                    let itemsHtml = report.data.map(item => 

                        `<div class="selection-item-subtitle" style="margin-left: 15px; padding: 4px 0;">

                            <strong>${item.key}</strong>: ${item.value}

                        </div>`

                    ).join('');

                    return `<div class="selection-item" style="cursor:default; background: white;">

                        <div class="selection-item-title" style="color: var(--primary);">${report.title}</div>

                        ${itemsHtml}

                    </div>`;

                }).join('');

            }

            DOMElements.selectionSection.classList.add('active');

        } catch (error) {

             showError('Failed to load insights.');

        } finally {

            showLoader(false);

        }

    }

    

    function switchTab(type) {

        currentSearchType = type;

        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

        document.getElementById(`tab-${type}`).classList.add('active');

        const placeholders = { business: 'Enter active business name...', owner: 'Enter owner/principal name...', address: 'Enter street address...' };

        DOMElements.searchInput.placeholder = placeholders[type];

        DOMElements.searchInput.value = ''; DOMElements.searchInput.focus();

    }

    const handleEnterKey = (e) => { if (e.key === 'Enter') performSearch(); };

    const showLoader = (show, text = 'Loading...') => { DOMElements.loader.classList.toggle('active', show); DOMElements.loaderText.textContent = text; };

    const showError = (message) => { DOMElements.errorContainer.innerHTML = `<div class="error-message">${message}</div>`; setTimeout(() => DOMElements.errorContainer.innerHTML = '', 5000); };

    function resetSearch(clearInput = true) {

        if (clearInput) DOMElements.searchInput.value = '';

        DOMElements.selectionSection.classList.remove('active'); DOMElements.dashboard.classList.remove('active');

        DOMElements.errorContainer.innerHTML = ''; DOMElements.noticeContainer.innerHTML = ''; DOMElements.cityFilters.style.display = 'none';

        DOMElements.propertyTbody.innerHTML = ''; DOMElements.activeBusinessesList.innerHTML = ''; DOMElements.principalsList.innerHTML = '';

        allProperties = []; allEntities.clear();

    }

    const openAboutModal = () => DOMElements.aboutModal.classList.add('active');

    const closeAboutModal = () => DOMElements.aboutModal.classList.remove('active');

    const closeModal = () => DOMElements.detailModal.classList.remove('active');

    const closeModalOnBackdrop = (e) => { if (e.target.classList.contains('modal')) e.target.classList.remove('active'); };

</script>

</body>

</html>



