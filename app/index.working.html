<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>they own WHAT??</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-hue: 221;
            --primary: hsl(var(--primary-hue), 83%, 53%);
            --primary-dark: hsl(var(--primary-hue), 83%, 43%);
            --secondary-hue: 162;
            --secondary: hsl(var(--secondary-hue), 72%, 46%);
            --danger: #ef4444; --warning: #f59e0b; --bg: #f1f5f9;
            --card-bg: #ffffff; --text: #0f172a; --text-muted: #64748b;
            --border: #e2e8f0; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-md: 0.375rem; --radius-lg: 0.5rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }
.container { max-width: 1400px; margin: 0 auto; padding: 15px; }        header p { color: var(--text-muted); font-size: 0.9rem; margin: 0; }
        .search-bar { background: var(--card-bg); padding: 15px 20px; box-shadow: var(--shadow); margin-top: 15px; border-radius: var(--radius-lg); border: 1px solid var(--border); }
        .search-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .search-tabs { display: flex; gap: 6px; }
        .tab-button { padding: 8px 16px; background: none; border: 1px solid var(--border); color: var(--text-muted); font-size: 0.9rem; font-weight: 500; cursor: pointer; border-radius: var(--radius-md); transition: all 0.2s; white-space: nowrap; }
        .tab-button.active { background: var(--primary); color: white; border-color: var(--primary); }
        .tab-button:hover:not(.active) { background: #f8fafc; }
        .search-input { flex: 1; padding: 10px 14px; font-size: 1rem; border: 1px solid var(--border); border-radius: var(--radius-md); transition: all 0.3s; min-width: 200px; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px hsla(var(--primary-hue), 83%, 53%, 0.2); }
        .btn { padding: 10px 20px; font-size: 0.95rem; font-weight: 600; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .btn-secondary:hover { background: var(--bg); }
        .btn-purple { background-color: #8b5cf6; color: white; } .btn-purple:hover { background-color: #7c3aed; }
        .dashboard { margin-top: 15px; display: none; } .dashboard.active { display: flex; flex-direction: column; height: calc(100vh - 200px); }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); padding: 20px; border-radius: var(--radius-lg); text-align: left; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .stat-number { font-size: 2.2rem; font-weight: 700; margin-bottom: 2px; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }
        
        .city-filters-container { display: none; background: var(--card-bg); padding: 15px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border); margin-bottom: 20px; }
        
        /* --- NEW: Header styles for City Filter box --- */
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .filter-title { 
            font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; 
            letter-spacing: 0.5px; font-weight: 600; margin-bottom: 0;
        }
        .btn-small {
            font-size: 0.85rem;
            padding: 6px 12px;
        }

        .city-btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .city-btn { padding: 8px 14px; background: white; border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; font-size: 0.85rem; display: flex; flex-direction: column; align-items: center; }
        .city-btn:hover { border-color: var(--primary); background: var(--bg); }
        .city-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .city-count { font-weight: 700; font-size: 1.1rem; }
        .city-name { font-size: 0.75rem; opacity: 0.9; }
        
        .content-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-bottom: 20px; }
        .network-panel { background: var(--card-bg); border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow); max-height: 600px; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .network-panel h3 { color: var(--text); margin-bottom: 15px; font-size: 1.1rem; }
        .entity-group { margin-bottom: 0; }
        #businesses-group { flex: 2; min-height: 0; overflow-y: auto; padding-right: 10px; }
        #principals-group { flex: 1; min-height: 0; overflow-y: auto; padding-right: 10px; border-top: 1px solid var(--border); margin-top: 15px; padding-top: 15px; }
        .entity-group h4 { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; background: var(--card-bg); padding-bottom: 5px; z-index: 1; }
        
        .entity-item { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 8px; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .entity-item:hover { border-color: var(--primary); background: white; }
        .entity-item.active-filter { border-color: var(--primary); background: hsl(var(--primary-hue), 83%, 97%); box-shadow: var(--shadow); }
        .entity-filter-area { flex-grow: 1; cursor: pointer; padding: 10px; }
        .entity-details-btn { cursor: pointer; padding: 8px 10px; font-size: 1.1rem; opacity: 0.6; transition: all 0.2s; border-radius: var(--radius-md); align-self: stretch; display: flex; align-items: center; border-left: 1px solid var(--border); }
        .entity-details-btn:hover { opacity: 1; background: #e2e8f0; }
        
        .entity-name { font-weight: 600; color: var(--text); font-size: 0.95rem; }
        .entity-meta { color: var(--text-muted); font-size: 0.85rem; margin-top: 2px; }
        .entity-badges { margin-top: 5px; display: flex; flex-wrap: wrap; gap: 6px; }
        .entity-badge { display: inline-block; background: hsl(var(--primary-hue), 83%, 95%); color: var(--primary-dark); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .property-badge { background-color: #8b5cf6; color: white; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 500; }
        .status-badge.active { background: hsl(var(--secondary-hue), 72%, 95%); color: hsl(var(--secondary-hue), 72%, 26%); }
        .status-badge.inactive { background: var(--text-muted); color: white; }
        .status-badge.dissolved { background: var(--danger); color: white; }
        .status-badge.forfeited { background: var(--warning); color: white; }
        .status-badge.rejected { background: #6b7280; color: white; }
        .status-badge.unknown { background: #d1d5db; color: #1f2937; }
        .link-badge { background-color: #0ea5e9; color: white; } /* --- NEW: Principal Link Badge Style --- */
        
        .table-panel { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); display: flex; flex-direction: column; min-height: 0; }
        .table-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        .table-title { font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 15px; }
        
        .filter-status { font-size: 0.9rem; font-weight: 500; background: var(--bg); padding: 4px 8px; border-radius: var(--radius-md); border: 1px solid var(--border); display: none; }
        .filter-status button { margin-left: 8px; background: none; border: none; color: var(--primary); cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        
        .table-actions { display: flex; gap: 10px; }
        .filter-input { padding: 6px 12px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 0.9rem; }
        .table-container { flex: 1; overflow-y: auto; }
        .property-table { width: 100%; border-collapse: collapse; } .property-table thead { background: var(--bg); position: sticky; top: 0; z-index: 10; }
        .property-table th { padding: 12px; text-align: left; font-weight: 600; color: var(--text-muted); border-bottom: 2px solid var(--border); font-size: 0.85rem; cursor: pointer; }
        .property-table th:hover { color: var(--primary); }
        .property-table td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .property-table tbody tr { cursor: pointer; transition: background 0.2s; }
        .property-table tbody tr:hover { background: var(--bg); }
        .map-link { color: var(--primary); text-decoration: none; font-weight: 500; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; } .modal.active { display: flex; }
        .modal-content { background: white; border-radius: var(--radius-lg); max-width: 800px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; } .modal-title { font-size: 1.2rem; font-weight: 600; } .modal-body { padding: 20px; overflow-y: auto; }
        .modal-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        .detail-section { margin-bottom: 20px; }
        .detail-section h4 { color: var(--primary); margin-bottom: 10px; font-size: 0.95rem; }
        .detail-item { display: flex; padding: 8px 0; border-bottom: 1px solid var(--bg); }
        .detail-label { font-weight: 500; color: var(--text-muted); min-width: 120px; font-size: 0.9rem; }

        .detail-link-item { padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 8px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .detail-link-item:hover { border-color: var(--primary); background: white; }

        .selection-section { display: none; margin-top: 20px; }
        .selection-section.active { display: block; } .selection-card { background: var(--card-bg); border-radius: var(--radius-lg); padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .selection-item { padding: 15px; margin-bottom: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s; }
        .selection-item:hover { border-color: var(--primary); background: hsl(var(--primary-hue), 83%, 97%); transform: translateY(-2px); box-shadow: var(--shadow); }
        .selection-item-title { font-weight: 600; } .selection-item-subtitle { color: var(--text-muted); font-size: 0.9rem; }
        
        .insight-item-group { background: white; border-radius: var(--radius-md); border: 1px solid var(--border); margin-bottom: 15px; overflow: hidden; }
        .insight-title { font-weight: 600; color: var(--primary); padding: 12px 15px; background: var(--bg); border-bottom: 1px solid var(--border); }
        .insight-item { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
        .insight-item:last-child { border-bottom: none; }
        .insight-item:hover { background: hsl(var(--primary-hue), 83%, 97%); transform: translateX(3px); }
        .insight-name { font-weight: 500; }
        .insight-value { font-weight: 600; color: var(--text-muted); }
        
        .loader { display: none; text-align: center; padding: 40px; background: var(--card-bg); border-radius: 12px; margin-top: 20px; box-shadow: var(--shadow); }
        .loader.active { display: block; } .spinner { border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { color: var(--text-muted); font-size: 1.1rem; }
        
        .error-message { background: #fef2f2; border-left: 4px solid var(--danger); padding: 15px; margin: 20px 0; border-radius: 4px; color: #991b1b; }
        .notice-message { background: #eff6ff; border-left: 4px solid var(--primary); padding: 15px; margin: 0 0 20px 0; border-radius: 4px; color: #1e40af; }
        
        .collapsible-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px; }
        .collapsible-header { cursor: pointer; padding: 8px 12px; background: var(--bg); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); transition: all 0.2s; }
        .collapsible-header:hover { background: #e2e8f0; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapsible-content.expanded { max-height: 500px; overflow-y: auto; margin-top: 10px; }
        .collapse-icon { transition: transform 0.3s; }
        .collapsible-header.expanded .collapse-icon { transform: rotate(180deg); }
        
        .report-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center; }
        .report-modal.active { display: flex; }
        .report-modal-content { background: white; border-radius: var(--radius-lg); width: 90%; max-width: 1000px; height: 80vh; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
        .report-modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .report-modal-title { font-size: 1.3rem; font-weight: 600; color: var(--text); }
        .report-modal-actions { display: flex; gap: 10px; }
        .modal-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-muted); cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: all 0.2s; }
        .modal-btn:hover { background: var(--bg); }
        .report-modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .minimized-report { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 12px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); cursor: pointer; display: none; z-index: 1500; }
        .minimized-report.active { display: block; }

        /* --- NEW: Responsive rules from previous step (included for completeness) --- */
        .btn-pink { background-color: #ec4899; color: white; }
        .btn-pink:hover { background-color: #db2777; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-actions { margin-left: auto; }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 800px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .header-actions {
                flex-wrap: wrap;
                gap: 8px;
                width: 100%;
            }
            .header-actions .btn {
                flex-grow: 1; 
            }
            
            .search-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-tabs {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                width: 100%;
            }
            .search-input {
                min-width: 100%;
            }
            .btn-primary, .btn-secondary {
                 width: 100%;
            }
            .content-grid {
                grid-template-columns: 1fr; /* Stack panels vertically */
            }
            
            /* --- NEW: Responsive stack for filter header --- */
            .filter-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
                body {
        overflow: auto;
        height: auto;
    }
    
    .dashboard.active {
        height: auto;
    }
        }
        /* --- New styles for inline notice --- */
        .panel-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* Re-applies margin that was on h3 */
        }
        .network-panel h3 {
            margin-bottom: 0; /* Remove old margin */
        }
        .notice-inline {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            background: var(--bg);
            padding: 4px 10px;
            border-radius: var(--radius-md);
        }
        .notice-inline strong {
            color: var(--text);
        }

        /* --- Vertical Space Adjustments --- */
        .network-panel {
            max-height: 800px; /* Increased from 600px */
        }
        .table-container {
            max-height: 700px; /* Increased from 500px to match */
        }
        .content-grid {
            margin-bottom: 10px; /* Reduced from 20px */
        }
    </style>
</head>
<body>
<header>
    <div class="container">
        <div class="header-content">
            <div>
                <h1>üè† they own WHAT??</h1>
                <p>Connecticut Property Network Explorer</p>
            </div>
            <div class="header-actions">
                <button id="show-insights-btn" class="btn btn-purple" onclick="showInsights()">üìä Insights</button>
                <button class="btn btn-pink" onclick="browseReports()">üìö Reports</button>
                <button class="btn btn-secondary" onclick="openAboutModal()">About</button>
            </div>
        </div>
    </div>
</header>
<div class="container">
        <div class="search-bar">
            <div class="search-controls">
                <div class="search-tabs">
                    <button id="tab-business" class="tab-button active" onclick="switchTab('business')">Business</button>
                    <button id="tab-owner" class="tab-button" onclick="switchTab('owner')">Owner</button>
                    <button id="tab-address" class="tab-button" onclick="switchTab('address')">Address</button>
                </div>
                <input type="text" class="search-input" id="search-input" placeholder="Enter active business name..." onkeypress="handleEnterKey(event)">
                <button class="btn btn-primary" id="search-button" onclick="performSearch()">Search</button>
                <button class="btn btn-secondary" onclick="resetSearch(true)">Clear</button>
            </div>
        </div>
        <div class="loader" id="loader"><div class="spinner"></div><p class="loader-text" id="loader-text">Searching records...</p></div>
        <div id="error-container"></div>
        <div class="selection-section" id="selection-section"><div class="selection-card"><h2 id="selection-title">Select an Entity</h2><div id="selection-list"></div></div></div>
        <div class="dashboard" id="dashboard">
            <div class="stats-row">
                <div class="stat-card"><div class="stat-number" id="total-properties">0</div><div class="stat-label">Properties Found</div></div>
                <div class="stat-card"><div class="stat-number" id="total-businesses">0</div><div class="stat-label">Unique Businesses</div></div>
                <div class="stat-card"><div class="stat-number" id="total-principals">0</div><div class="stat-label">Principals Found</div></div>
                <div class="stat-card"><div class="stat-number" id="total-value">$0</div><div class="stat-label">Total Assessed Value</div></div>
                <div class="stat-card"><div class="stat-number" id="total-appraised-value">$0</div><div class="stat-label">Total Appraised Value</div></div>
            </div>
            
            <div class="city-filters-container" id="city-filters-container" style="display: none;">
                <div class="filter-header"> 
                    <h4 class="filter-title">üèôÔ∏è Filter by City:</h4>
                    <button id="ai-digest-btn" class="btn btn-primary btn-small" onclick="generateAiReport()" style="display: none;">üß† Generate AI Digest</button>
                </div>
                <div class="city-btn-row" id="city-filters">
                    </div>
            </div>
            
            <div class="content-grid">
                <div class="network-panel" id="network-panel">
                    <div class="panel-header-flex">
                        <h3>Network Entities</h3>
                        <span id="network-notice-inline" class="notice-inline"></span>
                    </div>
                    <div class="entity-group" id="businesses-group">
                        <h4>Businesses</h4>
                        <div id="active-businesses-list"></div>
                        <div class="collapsible-section" id="inactive-section" style="display: none;">
                            <div class="collapsible-header" onclick="toggleInactive(this)">
                                <span id="inactive-count">0 Inactive Businesses</span><span class="collapse-icon">‚ñº</span>
                            </div>
                            <div class="collapsible-content" id="inactive-businesses-list"></div>
                        </div>
                    </div>
                    <div class="entity-group" id="principals-group">
                        <h4>Principals</h4>
                        <div id="principals-list"></div>
                    </div>
                </div>
                <div class="table-panel">
                    <div class="table-header">
                        <div class="table-title">
                            <span>Properties</span>
                            <span id="entity-filter-status" class="filter-status"></span>
                        </div>
                        <div class="table-actions">
                            <input type="text" class="filter-input" id="filter-input" placeholder="Filter table..." onkeyup="filterProperties()">
                            <button class="btn btn-secondary" onclick="exportToCSV()" style="font-size: 0.85rem; padding: 6px 12px;">Export CSV</button>
                        </div>
                    </div>
                    <div class="table-container"><table class="property-table" id="property-table"><thead><tr><th onclick="sortTable(0)">Address ‚Üï</th><th onclick="sortTable(1)">City ‚Üï</th><th onclick="sortTable(2)">Owner ‚Üï</th><th onclick="sortTable(3)">Assessed / Appraised Value ‚Üï</th><th>Map</th></tr></thead><tbody id="property-tbody"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

<div class="report-modal" id="report-modal">
        <div class="report-modal-content">
            <div class="report-modal-header">
                <h3 class="report-modal-title">Investigative Digest</h3>
                <div class="report-modal-actions">
                    <button class="modal-btn" onclick="downloadReport()" title="Download Report">üíæ</button>
                    <button class="modal-btn" onclick="minimizeReport()" title="Minimize">_</button>
                    <button class="modal-btn" onclick="closeReportModal()" title="Close">‚úï</button>
                </div>
            </div>
            <div class="report-modal-body" id="report-modal-body"></div>
        </div>
    </div>
    <div class="minimized-report" id="minimized-report" onclick="restoreReport()">
        üóûÔ∏è Investigative Digest (Click to restore)
    </div>
    
    <div class="modal" id="detail-modal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title" id="modal-title">Details</h3>
                    <p class="modal-subtitle" id="modal-subtitle"></p>
                </div>
                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 1.2rem;" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>
    <div class="modal" id="about-modal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">About This Project</h3>
                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 1.2rem;" onclick="closeAboutModal()">√ó</button>
            </div>
            <div class="modal-body" id="about-modal-body">
                 <h4>Data Sources</h4>
                 <p>This tool synthesizes data from several public sources to build its networks:</p>
                 <ul style="margin-left: 20px; list-style-type: disc;">
                     <li style="margin-bottom: 5px; margin-left: 5px;">
                         <a href="https://data.ct.gov/Business/Connecticut-Business-Registry-Business-Master/n7gp-d28j/about_data" target="_blank" rel="noopener noreferrer">CT Business Registry</a>: Used for all business information (name, status, address). This data is updated regularly from the source.
                     </li>
                     <li style="margin-bottom: 5px; margin-left: 5px;">
                         <a href="https://data.ct.gov/Business/Connecticut-Business-Registry-Principals/ka36-64k6/about_data" target="_blank" rel="noopener noreferrer">CT Business Principals</a>: Provides the links between businesses and their registered principals. This data is also updated regularly.
                     </li>
                     <li style="margin-bottom: 5px; margin-left: 5px;">
                         <a href="https://data.ct.gov/Local-Government/2024-Connecticut-Parcel-and-CAMA-Data/pqrn-qghw/about_data" target="_blank" rel="noopener noreferrer">CT 2024 CAMA Parcel Data</a>: Provides the base layer of property, ownership, and assessment data for the state.
                     </li>
                     <li style="margin-bottom: 5px; margin-left: 5px;">
                         <b>Vision Appraisal (VGSI)</b>: Missing/outdated property details have been scraped from individual town appraisal websites to supplement the state data.
                     </li>
                 </ul>
    
                 <h4>How It Works</h4>
                 <p>The network mapping is generated through an automated backend process:</p>
                 <ul style="margin-left: 20px; list-style-type: disc;">
                     <li style="margin-bottom: 5px; margin-left: 5px;">
                         <b>Normalization:</b> All business and principal names are "normalized" by uppercasing, removing punctuation, and stripping common suffixes.
                     </li>
                     <li style="margin-bottom: 5px; margin-left: 5px;">
                         <b>Linking:</b> Properties are linked to their listed owner by matching against the normalized entity names. Principals are linked to businesses based on the registry data.
                     </li>
                     <li style="margin-bottom: 5px; margin-left: 5px;">
                         <b>Network Discovery:</b> The system builds a graph of these connections using a depth-limited breadth-first search algorithm to explore related entities and uncover hidden connections.
                     </li>
                     <li style="margin-bottom: 5px; margin-left: 5px;">
                         <b>Caching:</b> These complex networks are pre-calculated and cached to allow for fast loading when you search.
                     </li>
                 </ul>
    
                 <h4>Purpose & Disclaimer</h4>
                 <p>This tool was developed by Salmun Kazerounian for investigative research and tenant advocacy. No guarantee is made regarding the timeliness or completeness of the source data or the accuracy of the network-building algorithms. Users should verify findings with primary sources.</p>
                 
                 <h4>Contact</h4>
                 <p>For questions or feedback, please contact Salmun Kazerounian at <a href="mailto:salmunk@gmail.com">salmunk@gmail.com</a>.</p>
            </div>
        </div>
    </div>
    
<script>
    // --- Global State ---
    let allProperties = [], allEntities = new Map(), allLinks = {};
    let currentSearchType = 'business', currentCityFilter = null, currentEntityFilter = null;
    let reportContent = null; 

    // --- DOM Elements ---
    const DOMElements = {
        loader: document.getElementById('loader'), loaderText: document.getElementById('loader-text'),
        errorContainer: document.getElementById('error-container'), networkNoticeInline: document.getElementById('network-notice-inline'), 
        selectionList: document.getElementById('selection-list'), selectionSection: document.getElementById('selection-section'), selectionTitle: document.getElementById('selection-title'), dashboard: document.getElementById('dashboard'),
        propertyTbody: document.getElementById('property-tbody'), activeBusinessesList: document.getElementById('active-businesses-list'),
        inactiveBusinessesList: document.getElementById('inactive-businesses-list'), inactiveSection: document.getElementById('inactive-section'),
        inactiveCount: document.getElementById('inactive-count'), principalsList: document.getElementById('principals-list'), 
        totalProperties: document.getElementById('total-properties'), totalBusinesses: document.getElementById('total-businesses'), 
        totalPrincipals: document.getElementById('total-principals'), totalValue: document.getElementById('total-value'),
        totalAppraisedValue: document.getElementById('total-appraised-value'), 
        cityFiltersContainer: document.getElementById('city-filters-container'),
        cityFilters: document.getElementById('city-filters'),
        entityFilterStatus: document.getElementById('entity-filter-status'),
        aiDigestBtn: document.getElementById('ai-digest-btn'), // --- NEW: AI Digest Button ---
        reportModal: document.getElementById('report-modal'),
        reportModalBody: document.getElementById('report-modal-body'),
        minimizedReport: document.getElementById('minimized-report'),
        detailModal: document.getElementById('detail-modal'), aboutModal: document.getElementById('about-modal'),
        modalTitle: document.getElementById('modal-title'), modalSubtitle: document.getElementById('modal-subtitle'),
        modalBody: document.getElementById('modal-body'), searchInput: document.getElementById('search-input'),
        filterInput: document.getElementById('filter-input')
    };
    
    // --- Utility & Formatting ---
    const formatCurrency = (v) => Number(v) ? '$' + Number(v).toLocaleString('en-US', { maximumFractionDigits: 0 }) : 'N/A';
    
    const formatValue = (key, value) => {
        if (!value || value === null || (typeof value === 'string' && value.trim() === '')) return 'N/A';
        if (key.includes('value') || key.includes('amount')) return formatCurrency(value);
        if (key.includes('date')) {
            try {
                const date = new Date(value);
                if (isNaN(date.getTime())) return value;
                return date.toLocaleDateString();
            } catch (e) { return value; }
        }
        return value;
    };
    
    // --- NEW: Frontend Normalizer (from previous step) ---
    function normalizeForMatch(name) {
        if (!name) return '';
        let norm = name.toUpperCase()
            .replace(/[,.'"`"&]/g, '') // Remove common punctuation
            .replace(/\s+/g, ' ')      // Collapse whitespace
            .trim();
        
        const suffixes = [
            ' LLC', ' L L C', ' LLP', ' L L P', ' INC', ' CORP', ' LP', ' LTD', 
            ' COMPANY', ' PROPERTIES', ' REALTY', ' HOLDINGS', ' MANAGEMENT'
        ];
        
        for (const suffix of suffixes) {
            if (norm.endsWith(suffix)) {
                norm = norm.substring(0, norm.length - suffix.length).trim();
                break; // Only strip one suffix
            }
        }
        return norm;
    }
    
    // --- API & Fetching ---
    async function apiRequest(endpoint, options = {}) {
        try {
            const response = await fetch(`/api/${endpoint}`, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: `HTTP error! ${response.status}` }));
                throw new Error(errorData.detail);
            }
            if (response.status === 204) return null;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            }
            return response.text();
        } catch (error) {
            showError(`API Request Failed: ${error.message}`);
            console.error(`API request failed for /api/${endpoint}:`, error);
            throw error;
        }
    }
    
    // --- Search & Selection ---
    async function performSearch() {
        const term = DOMElements.searchInput.value.trim();
        if (term.length < 3) return showError("Please enter at least 3 characters.");
        resetSearch(false); // This already clears the dashboard
        showLoader(true, 'Searching for matching entities...');
        try {
            const results = await apiRequest(`search?type=${currentSearchType}&term=${encodeURIComponent(term)}`);
            if (!results || results.length === 0) return showError("No results found.");
            displaySelection(results);
        } catch (error) {
        } finally {
            showLoader(false);
        }
    }

    function displaySelection(results) {
        DOMElements.selectionTitle.textContent = `Found ${results.length} results. Please select one:`;
        DOMElements.selectionList.innerHTML = results.map(item => {
            const safeId = String(item.id).replace(/'/g, "\\'");
            const safeName = String(item.name).replace(/'/g, "\\'");
            const contextHTML = item.context ? `<div class="selection-item-subtitle">${item.context}</div>` : '';
            const networkBadge = item.network_id ? `<span class="entity-badge" style="background: #6d28d9; color: white; margin-top: 5px;">Part of Network #${item.network_id}</span>` : '';

            return `<div class="selection-item" onclick="startNetworkLoad({id: '${safeId}', name: '${safeName}'}, '${item.type}')">
                <div class="selection-item-title">${item.name}</div>
                ${contextHTML}
                ${networkBadge}
            </div>`;
        }).join('');
        DOMElements.selectionSection.classList.add('active');
    }
    
    function loadNetworkFromInsight(entityInfo, entityType) {
        resetSearch(true); // Reset the whole interface
        startNetworkLoad(entityInfo, entityType);
    }

    // --- Core Network Logic ---
    async function startNetworkLoad(startEntity, startType) {
        resetSearch(false);
        showLoader(true, `Loading network entities for ${startEntity.name}...`);
        DOMElements.dashboard.classList.add('active');
        allEntities.clear(); allProperties = []; allLinks = {}; 
        DOMElements.propertyTbody.innerHTML = ''; 

        try {
            const response = await fetch('/api/network/stream_load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ entity_id: startEntity.id, entity_type: startType, entity_name: startEntity.name })
            });
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({ detail: `HTTP error! status: ${response.status}` }));
                throw new Error(errorData.detail || `HTTP ${response.status}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                for (const line of lines) {
                    if (line.trim() === '') continue;
                    try {
                        const chunk = JSON.parse(line);
                        if (chunk.type === 'entities') {
                            showLoader(true, `Loading properties...`);
                            processEntityChunk(chunk.data.entities);
                            allLinks = chunk.data.links || {};
                            renderEntityLists();
                        } else if (chunk.type === 'properties') {
                            allProperties.push(...chunk.data);
                            appendPropertiesToTable(chunk.data);
                            showLoader(true, `Loading properties... (${allProperties.length} found)`);
                        } else if (chunk.type === 'done') {
                            showLoader(false);
                            renderStatsAndBadges();
                            updateCityFilters();
                            checkIsolatedNotice(startEntity, startType);
                            loadCachedReportsCount();
                            DOMElements.aiDigestBtn.style.display = 'block'; // --- SHOW AI BUTTON ---
                            return;
                        } else if (chunk.type === 'error') {
                            throw new Error(chunk.data);
                        }
                    } catch (e) { console.error('Error parsing stream chunk:', e, 'Chunk:', line); }
                }
            }
        } catch (error) {
            showError(`Failed to load network: ${error.message}`);
            showLoader(false);
        }
    }
    
    function processEntityChunk(entities) {
        (entities || []).forEach(entity => {
            const key = `${entity.type}_${entity.id}`;
            if (!allEntities.has(key)) allEntities.set(key, entity);
        });
    }

    function appendPropertiesToTable(properties) {
        const html = properties.map(prop => {
            const mapQuery = `${prop.address || ''}, ${prop.city || ''}`;
            const assessed = formatCurrency(prop.details?.assessed_value);
            const appraised = formatCurrency(prop.details?.appraised_value);
            const propDetails = JSON.stringify(prop.details || {}).replace(/'/g, "\\'");
            return `<tr onclick='showPropertyDetails(${propDetails})'>
                <td>${prop.address || 'N/A'}</td>
                <td>${prop.city || 'N/A'}</td>
                <td>${prop.owner || 'N/A'}</td>
                <td>${assessed} / ${appraised}</td>
                <td><a href="https://maps.google.com/maps?q=${encodeURIComponent(mapQuery)}" 
                    target="_blank" class="map-link" onclick="event.stopPropagation()">üó∫Ô∏è</a></td>
            </tr>`;
        }).join('');
        DOMElements.propertyTbody.insertAdjacentHTML('beforeend', html);
    }
    
    // --- UPDATED: Sorts principals and adds link badges ---
    function renderEntityLists() {
        const entities = Array.from(allEntities.values());
        const allBusinesses = entities.filter(e => e.type === 'business');
        let principals = entities.filter(e => e.type === 'principal'); // Use 'let'
        const activeBusinesses = allBusinesses.filter(b => b.status && b.status.toUpperCase() === 'ACTIVE');
        const inactiveBusinesses = allBusinesses.filter(b => !b.status || b.status.toUpperCase() !== 'ACTIVE');
        
        activeBusinesses.sort((a, b) => a.name.localeCompare(b.name));
        inactiveBusinesses.sort((a, b) => a.name.localeCompare(b.name));
        
        const renderBusiness = (entity) => {
            const statusClass = (entity.status || 'unknown').toLowerCase();
            const meta = entity.details?.business_address || entity.details?.business_city || 'No address';
            const entityDetails = JSON.stringify(entity).replace(/'/g, "\\'");
            const safeId = String(entity.id).replace(/'/g, "\\'");
            const key = `${entity.type}_${entity.id}`;
            
            return `<div class="entity-item" id="entity-dom-${key}">
                <div class="entity-filter-area" onclick="filterByEntity('${entity.type}', '${safeId}')" title="Filter properties by this entity">
                    <div class="entity-name">${entity.name}</div>
                    <div class="entity-meta">${meta}</div>
                    <div class="entity-badges">
                        <span class="status-badge ${statusClass}">${entity.status || 'UNKNOWN'}</span>
                        <span class="entity-badge property-badge" id="propbadge-${entity.type}-${entity.id}" style="display: none;"></span>
                    </div>
                </div>
                <div class="entity-details-btn" onclick='showEntityDetails(${entityDetails})' title="Show details">‚ÑπÔ∏è</div>
            </div>`;
        };
        DOMElements.activeBusinessesList.innerHTML = activeBusinesses.map(renderBusiness).join('');
        if (inactiveBusinesses.length > 0) {
            DOMElements.inactiveSection.style.display = 'block';
            DOMElements.inactiveCount.textContent = `${inactiveBusinesses.length} Inactive`;
            DOMElements.inactiveBusinessesList.innerHTML = inactiveBusinesses.map(renderBusiness).join('');
        } else {
            DOMElements.inactiveSection.style.display = 'none';
        }
        
        // --- NEW: Calculate link counts for sorting principals ---
        const principalLinkCounts = new Map();
        principals.forEach(p => {
            const key = `principal_${p.id}`;
            const count = allLinks.principal_to_business?.filter(link => link.source === key).length || 0;
            principalLinkCounts.set(p.id, count);
        });

        // --- NEW: Sort principals list by count (descending) ---
        principals.sort((a, b) => {
            const countA = principalLinkCounts.get(a.id) || 0;
            const countB = principalLinkCounts.get(b.id) || 0;
            return countB - countA;
        });

        // --- UPDATED: Principals map now adds the badge ---
        DOMElements.principalsList.innerHTML = principals.map(entity => {
            const entityDetails = JSON.stringify(entity).replace(/'/g, "\\'");
            const safeId = String(entity.id).replace(/'/g, "\\'");
            const key = `${entity.type}_${entity.id}`;
            const linkCount = principalLinkCounts.get(entity.id) || 0; // Get the count

            let badgeHtml = '';
            if (linkCount > 0) {
                const plural = linkCount === 1 ? 'business' : 'businesses';
                badgeHtml = `<span class="entity-badge link-badge">${linkCount} linked ${plural}</span>`;
            }
            
            return `
            <div class="entity-item" id="entity-dom-${key}">
                <div class="entity-filter-area" onclick="filterByEntity('${entity.type}', '${safeId}')" title="Filter properties by this entity">
                    <div class="entity-name">${entity.name}</div>
                    <div class="entity-badges">${badgeHtml}</div>
                </div>
                <div class="entity-details-btn" onclick='showEntityDetails(${entityDetails})' title="Show details">‚ÑπÔ∏è</div>
            </div>`
        }).join('');
    }

    // --- UPDATED: Uses normalized matching (from previous fix) ---
    function renderStatsAndBadges() {
        const allBusinesses = Array.from(allEntities.values()).filter(e => e.type === 'business');
        
        const propertyCountsByNormName = new Map();
        for (const p of allProperties) {
            if (p.owner) {
                const normOwner = normalizeForMatch(p.owner);
                propertyCountsByNormName.set(normOwner, (propertyCountsByNormName.get(normOwner) || 0) + 1);
            }
        }

        allBusinesses.forEach(biz => {
            const bizNormName = normalizeForMatch(biz.name);
            const count = propertyCountsByNormName.get(bizNormName) || 0; 
            
            biz.propertyCount = count; // Store for sorting
            if (count > 0) {
                const badge = document.getElementById(`propbadge-${biz.type}-${biz.id}`);
                if (badge) {
                    badge.textContent = `${count} properties`;
                    badge.style.display = 'inline-block';
                }
            }
        });
        
        const reSortBusinesses = (container) => {
             Array.from(container.children).sort((a, b) => {
                    const getCount = (el) => {
                        try {
                            const key = el.id.replace('entity-dom-','');
                            const bizA = allEntities.get(key);
                            return bizA?.propertyCount || 0;
                        } catch (e) { return 0; }
                    };
                    return getCount(b) - getCount(a);
                }).forEach(node => container.appendChild(node));
        };
        reSortBusinesses(DOMElements.activeBusinessesList);
        reSortBusinesses(DOMElements.inactiveBusinessesList);

        DOMElements.totalProperties.textContent = allProperties.length.toLocaleString();
        DOMElements.totalBusinesses.textContent = allBusinesses.length;
        DOMElements.totalPrincipals.textContent = Array.from(allEntities.values()).filter(e => e.type === 'principal').length.toLocaleString();
        const totalValue = allProperties.reduce((sum, p) => sum + (Number(p.details?.assessed_value) || 0), 0);
        DOMElements.totalValue.textContent = formatCurrency(totalValue);
        const totalAppraisedValue = allProperties.reduce((sum, p) => sum + (Number(p.details?.appraised_value) || 0), 0);
        DOMElements.totalAppraisedValue.textContent = formatCurrency(totalAppraisedValue);
    }
    
function checkIsolatedNotice(startEntity, startType) {
        if (allEntities.size <= 1) {
            let notice = `<strong>Notice:</strong> This entity is not part of a larger pre-calculated network.`;
            if (startType === 'principal' && allProperties.length > 0) {
                notice = `<strong>Notice:</strong> ${startEntity.name} is not associated with any businesses in the registry. Showing properties owned directly under this name.`;
                document.getElementById('network-panel').style.display = 'none';
                document.querySelector('.content-grid').style.gridTemplateColumns = '1fr';
            }
            // Use the original (blue box) styling for warnings
            DOMElements.networkNoticeInline.innerHTML = `<div class="notice-message">${notice}</div>`;
            DOMElements.networkNoticeInline.className = ''; // Remove span styling
        } else {
            // Use the new inline span styling for success messages
            DOMElements.networkNoticeInline.innerHTML = `Loading complete`;
            DOMElements.networkNoticeInline.className = 'notice-inline'; // Add span styling
        }
    }

    function showEntityDetails(entity) {
        DOMElements.modalTitle.textContent = entity.name;
        DOMElements.modalSubtitle.textContent = entity.type.charAt(0).toUpperCase() + entity.type.slice(1);
        let body = '<div class="detail-section"><h4>Details</h4>';
        if (entity.details && Object.keys(entity.details).length > 0) {
            Object.entries(entity.details).forEach(([k, v]) => {
                const val = formatValue(k, v);
                if (val !== 'N/A') {
                    body += `<div class="detail-item"><span class="detail-label">${k.replace(/_/g, ' ')}:</span><span>${val}</span></div>`;
                }
            });
        } else { body += `<p>No registry details available.</p>`; }
        body += '</div>';
        
        if (entity.type === 'business' && allLinks.business_to_principal) {
            body += '<div class="detail-section"><h4>Principals in Network</h4>';
            const entityKey = `${entity.type}_${entity.id}`;
            const principals = [];
            allLinks.business_to_principal.forEach(link => {
                if (link.source === entityKey) {
                    const prin = allEntities.get(link.target);
                    if (prin) principals.push(prin);
                }
            });
            
            if (principals.length > 0) {
                body += principals.map(p => {
                    const pDetails = JSON.stringify(p).replace(/'/g, "\\'");
                    return `<div class="detail-link-item" onclick='showEntityDetails(${pDetails})'>${p.name}</div>`;
                }).join('');
            } else {
                body += `<p>No principals found in this network.</p>`;
            }
            body += '</div>';

        } else if (entity.type === 'principal' && allLinks.principal_to_business) {
            body += '<div class="detail-section"><h4>Associated Businesses in Network</h4>';
            const entityKey = `${entity.type}_${entity.id}`;
            const businesses = [];
            allLinks.principal_to_business.forEach(link => {
                if (link.source === entityKey) {
                    const biz = allEntities.get(link.target);
                    if (biz) businesses.push(biz);
                }
            });
            
            if (businesses.length > 0) {
                body += businesses.map(b => {
                    const bDetails = JSON.stringify(b).replace(/'/g, "\\'");
                    return `<div class="detail-link-item" onclick='showEntityDetails(${bDetails})'>${b.name}</div>`;
                }).join('');
            } else {
                body += `<p>No associated businesses found in this network.</p>`;
            }
            body += '</div>';
        }

        DOMElements.modalBody.innerHTML = body;
        DOMElements.detailModal.classList.add('active');
    }

    function showPropertyDetails(details) {
        DOMElements.modalTitle.textContent = details.location || 'Property Details';
        DOMElements.modalSubtitle.textContent = details.property_city || '';
        let body = '<div class="detail-section"><h4>Details</h4>';
        Object.entries(details).forEach(([k, v]) => {
            const val = formatValue(k, v);
            if (val !== 'N/A') {
                body += `<div class="detail-item"><span class="detail-label">${k.replace(/_/g, ' ')}:</span><span>${val}</span></div>`;
            }
        });
        DOMElements.modalBody.innerHTML = body + '</div>';
        DOMElements.detailModal.classList.add('active');
    }
    
    // --- UPDATED: Uses normalized matching (from previous fix) ---
    function updatePropertyTable() {
        let filteredProperties = allProperties;

        if (currentCityFilter) {
            filteredProperties = filteredProperties.filter(p => p.city && p.city.toUpperCase() === currentCityFilter);
        }

        if (currentEntityFilter) {
            const entity = currentEntityFilter;
            let namesToFilter = new Set();
            namesToFilter.add(normalizeForMatch(entity.name)); 

            if (entity.type === 'principal' && allLinks.principal_to_business) {
                const entityKey = `${entity.type}_${entity.id}`;
                allLinks.principal_to_business.forEach(link => {
                    if (link.source === entityKey) {
                        const biz = allEntities.get(link.target);
                        if (biz) namesToFilter.add(normalizeForMatch(biz.name));
                    }
                });
            }
            
            filteredProperties = filteredProperties.filter(p => {
                return p.owner && namesToFilter.has(normalizeForMatch(p.owner));
            });
        }
        
        DOMElements.propertyTbody.innerHTML = filteredProperties.map(prop => {
            const mapQuery = `${prop.address || ''}, ${prop.city || ''}`;
            const assessed = formatCurrency(prop.details?.assessed_value);
            const appraised = formatCurrency(prop.details?.appraised_value);
            const propDetails = JSON.stringify(prop.details || {}).replace(/'/g, "\\'");
            return `<tr onclick='showPropertyDetails(${propDetails})'>
                <td>${prop.address || 'N/A'}</td>
                <td>${prop.city || 'N/A'}</td>
                <td>${prop.owner || 'N/A'}</td>
                <td>${assessed} / ${appraised}</td>
                <td><a href="http://googleusercontent.com/maps/google.com/0{encodeURIComponent(mapQuery)}" 
                    target="_blank" class="map-link" onclick="event.stopPropagation()">üó∫Ô∏è</a></td>
            </tr>`;
        }).join('');
    }

    function updateCityFilters() {
        if (allProperties.length === 0) {
            DOMElements.cityFiltersContainer.style.display = 'none';
            return;
        }
        const cityCounts = {};
        allProperties.forEach(prop => {
            const city = prop.city?.toUpperCase() || 'UNKNOWN';
            cityCounts[city] = (cityCounts[city] || 0) + 1;
        });
        const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
        
        let html = `<button class="city-btn active" onclick="filterByCity(null, this)">
                        <div class="city-count">${allProperties.length}</div>
                        <div class="city-name">All Cities</div>
                    </button>`;
                   
        sortedCities.forEach(([city, count]) => {
            const displayCity = city.split(' ').map(word => word.charAt(0) + word.slice(1).toLowerCase()).join(' ');
            html += `<button class="city-btn" onclick="filterByCity('${city}', this)">
                <div class="city-count">${count}</div>
                <div class="city-name">${displayCity}</div>
            </button>`;
        });
        DOMElements.cityFilters.innerHTML = html;
        DOMElements.cityFiltersContainer.style.display = 'block';
    }
    
    function filterByCity(city, btnElement) {
        clearCityFilter(false);
        currentCityFilter = city;
        if(btnElement) btnElement.classList.add('active');
        clearEntityFilter(false);
        updatePropertyTable();
    }
    
    function clearCityFilter(update = true) {
        currentCityFilter = null;
        document.querySelectorAll('#city-filters button').forEach(btn => btn.classList.remove('active'));
        const allCitiesBtn = document.querySelector('#city-filters button');
        if (allCitiesBtn) allCitiesBtn.classList.add('active');
        if (update) updatePropertyTable();
    }
    
    function filterByEntity(type, id) {
        const key = `${type}_${id}`;
        currentEntityFilter = allEntities.get(key);
        if (!currentEntityFilter) return;

        document.querySelectorAll('.entity-item.active-filter').forEach(el => el.classList.remove('active-filter'));
        const domId = `entity-dom-${key}`;
        const el = document.getElementById(domId);
        if (el) el.classList.add('active-filter');

        DOMElements.entityFilterStatus.innerHTML = `Filtering by: <strong>${currentEntityFilter.name}</strong> <button onclick="clearEntityFilter(true)">Show All</button>`;
        DOMElements.entityFilterStatus.style.display = 'inline-block';
        
        clearCityFilter(false);
        updatePropertyTable();
    }

    function clearEntityFilter(update = true) {
        currentEntityFilter = null;
        DOMElements.entityFilterStatus.style.display = 'none';
        document.querySelectorAll('.entity-item.active-filter').forEach(el => el.classList.remove('active-filter'));
        if (update) updatePropertyTable();
    }

    function toggleInactive(header) {
        header.classList.toggle('expanded');
        header.nextElementSibling.classList.toggle('expanded');
    }

    function sortTable(columnIndex) {
        const table = document.getElementById('property-table');
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        const th = table.querySelectorAll('th')[columnIndex];
        const isAsc = !(th.dataset.sort === 'asc');
        rows.sort((a, b) => {
            let aText = a.cells[columnIndex].textContent.trim();
            let bText = b.cells[columnIndex].textContent.trim();
            if (columnIndex === 3) {
                const aVal = parseFloat(aText.split('/')[0].trim().replace(/[$,]/g, '')) || 0;
                const bVal = parseFloat(bText.split('/')[0].trim().replace(/[$,]/g, '')) || 0;
                return isAsc ? aVal - bVal : bVal - aVal;
            }
            return isAsc ? aText.localeCompare(bText, undefined, {numeric: true}) : bText.localeCompare(aText, undefined, {numeric: true});
        });
        tbody.append(...rows);
        table.querySelectorAll('th').forEach(h => h.dataset.sort = '');
        th.dataset.sort = isAsc ? 'asc' : 'desc';
    }

    function filterProperties() {
        const filter = DOMElements.filterInput.value.toUpperCase();
        DOMElements.propertyTbody.querySelectorAll('tr').forEach(row => {
            row.style.display = row.textContent.toUpperCase().includes(filter) ? '' : 'none';
        });
    }

    function exportToCSV() {
        if (allProperties.length === 0) return;
        const headers = ['Address', 'City', 'Owner', 'Assessed Value', 'Appraised Value', 'Property Type', 'Sale Amount', 'Sale Date', 'Full Location'];
        let csv = headers.join(',') + '\n';
        
        const rows = Array.from(DOMElements.propertyTbody.rows);
        const visiblePropertyAddresses = new Set(rows.filter(r => r.style.display !== 'none').map(r => r.cells[0].textContent));
        const propertiesToExport = allProperties.filter(p => visiblePropertyAddresses.has(p.address));

        propertiesToExport.forEach(p => {
            const details = p.details || {};
            const row = [ p.address, p.city, p.owner, details.assessed_value, details.appraised_value, details.property_type, details.sale_amount, details.sale_date, details.location ].map(val => `"${(val || '').toString().replace(/"/g, '""')}"`).join(',');
            csv += row + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `property_network_export_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    // --- Report Functions ---
    function openReportModal(content) {
        reportContent = content;
        DOMElements.reportModalBody.innerHTML = content;
        DOMElements.reportModal.classList.add('active');
        DOMElements.minimizedReport.classList.remove('active');
    }
    function closeReportModal() {
        DOMElements.reportModal.classList.remove('active');
        reportContent = null;
    }
    function minimizeReport() {
        DOMElements.reportModal.classList.remove('active');
        DOMElements.minimizedReport.classList.add('active');
    }
    function restoreReport() {
        if (reportContent) {
            DOMElements.reportModal.classList.add('active');
            DOMElements.minimizedReport.classList.remove('active');
        }
    }
    
    // --- UPDATED: generateAiReport (sends new cache key data) ---
    async function generateAiReport() {
        showLoader(true, 'Generating AI digest...');
        try {
            // Find top business (by property count)
            const sortedBusinesses = Array.from(allEntities.values())
                .filter(e => e.type === 'business')
                .sort((a, b) => (b.propertyCount || 0) - (a.propertyCount || 0));
            const topBusinessName = sortedBusinesses.length > 0 ? sortedBusinesses[0].name : '';
            const businessNames = sortedBusinesses.map(e => e.name);

            // --- NEW: Find top principal (by link count) ---
            const principals = Array.from(allEntities.values()).filter(e => e.type === 'principal');
            const principalLinkCounts = new Map();
            principals.forEach(p => {
                const key = `principal_${p.id}`;
                const count = allLinks.principal_to_business?.filter(link => link.source === key).length || 0;
                principalLinkCounts.set(p.id, count);
            });
            principals.sort((a, b) => (principalLinkCounts.get(b.id) || 0) - (principalLinkCounts.get(a.id) || 0));
            
            const topPrincipalName = principals.length > 0 ? principals[0].name : '';
            // --- END NEW LOGIC ---
            
            const networkStats = {
                total_properties: allProperties.length,
                total_value: allProperties.reduce((sum, p) => sum + (Number(p.details?.assessed_value) || 0), 0),
                total_businesses: allBusinesses.length,
                total_principals: principals.length
            };

            // --- UPDATED API REQUEST PAYLOAD ---
            const response = await apiRequest('generate-report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    business_names: businessNames, 
                    top_principal: topPrincipalName, 
                    network_stats: networkStats 
                })
            });
            
            if (!response || (typeof response === 'object' && !response.report)) {
                 throw new Error("Received no report content from server.");
            }
            const reportHTML = (typeof response === 'object') ? response.report : response;
            openReportModal(reportHTML);
        } catch (error) {
            showError(`Failed to generate AI report: ${error.message}`);
        } finally {
            showLoader(false);
        }
    }

    function downloadReport() {
        if (!reportContent) {
            showError("No report content to download.");
            return;
        }
        const entityNames = Array.from(allEntities.values()).slice(0, 4).map(e => e.name).join(', ');
        const html = `
            <!DOCTYPE html>
            <html>
            <head><meta charset="UTF-8"><title>Network Report - ${entityNames}</title>
            <style>
                body { font-family: 'Inter', -apple-system, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; }
                h3, h4 { color: #2563eb; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                a { color: #2563eb; } ul { margin-bottom: 15px; }
                .metadata { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
            </style></head>
            <body>
                <div class="metadata">
                    <h1>Network Investigation Report</h1>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Primary Entities:</strong> ${entityNames}</p>
                    <p><strong>Total Properties:</strong> ${allProperties.length}</p>
                    <p><strong>Total Network Size:</strong> ${allEntities.size} entities</p>
                </div>
                ${reportContent}
            </body>
            </html>
        `;
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `network_report_${new Date().toISOString().slice(0,10)}.html`;
        a.click();
        URL.revokeObjectURL(url);
    }
    async function browseReports() {
        resetSearch(true); // Changed to true to clear input
        showLoader(true, 'Loading cached reports...');
        try {
            const reports = await apiRequest('cached-reports');
            DOMElements.selectionTitle.textContent = 'Browse Cached Reports';
            
            if (reports.length === 0) {
                 DOMElements.selectionList.innerHTML = `<div class="notice-message" style="margin:0;">No cached reports found.</div>`;
                 return;
            }

            const groups = new Map();
            for (const report of reports) {
                if (!groups.has(report.norm_name)) {
                    groups.set(report.norm_name, []);
                }
                groups.get(report.norm_name).push(report);
            }

            let html = '';
            for (const [norm_name, report_list] of groups.entries()) {
                const title_name = report_list[0].entity_name; 
                html += `<div class="insight-item-group">`; 
                html += `<div class="insight-title">${title_name}</div>`;
                html += report_list.map(report => {
                    const date = new Date(report.created_at).toLocaleString(); 
                    const size = (report.size / 1024).toFixed(1);
                    const safe_name = report.entity_name.replace(/'/g, "\\'"); 
                    
                    return `<div class="insight-item" onclick="viewCachedReport('${safe_name}')" title="Click to view this version">
                                <span class="insight-name" style="font-weight: 400; font-size: 0.9rem;">Generated: ${date}</span>
                                <span class="insight-value">${size} KB</span>
                            </div>`;
                }).join('');
                html += `</div>`;
            }
            DOMElements.selectionList.innerHTML = html;
            DOMElements.selectionSection.classList.add('active');

        } catch (error) {
            showError('Failed to load cached reports');
        } finally {
            showLoader(false);
        }
    }
    async function viewCachedReport(entityName) {
        showLoader(true, 'Loading report...');
        try {
            const report = await apiRequest(`cached-report/${encodeURIComponent(entityName)}`);
            const reportHTML = `
                <div style="background: #eff6ff; padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #90cdf4;">
                    <strong>Cached Report for:</strong> ${report.entity_name}<br>
                    <strong>Generated:</strong> ${new Date(report.created_at).toLocaleString()}
                </div>
                ${report.report_html}`;
            openReportModal(reportHTML);
            DOMElements.selectionSection.classList.remove('active');
        } catch (error) {
            showError('Failed to load report');
        } finally {
            showLoader(false);
        }
    }
    async function loadCachedReportsCount() {
        try {
            // const result = await apiRequest('cached-reports-count');
        } catch (error) {
            console.error('Failed to load cached reports count:', error);
        }
    }

    async function showInsights() {
        resetSearch(true); // Changed to true
        showLoader(true, "Fetching insights...");
        try {
            const reports = await apiRequest('insights'); 
            DOMElements.selectionTitle.textContent = 'Network Insights';
            if (reports.length === 0) {
                 DOMElements.selectionList.innerHTML = `<div class="notice-message" style="margin:0;">No insights found. Run the generate_insights.py script.</div>`;
            } else {
                DOMElements.selectionList.innerHTML = reports.map(report => {
                    let itemsHtml = report.data.map(item => {
                        const safeId = (item.entity_id || '').replace(/'/g, "\\'");
                        const safeName = (item.entity_name || '').replace(/'/g, "\\'");
                        const safeType = (item.entity_type || '').replace(/'/g, "\\'");
                        
                        return `<div class="insight-item" onclick="loadNetworkFromInsight({id: '${safeId}', name: '${safeName}'}, '${safeType}')" title="Click to load this network">
                                    <span class="insight-name">${item.name}</span>
                                    <span class="insight-value">${item.value} Properties</span>
                                </div>`;
                    }).join('');
                    
                    return `<div class="insight-item-group">
                                <div class="insight-title">${report.title}</div>
                                ${itemsHtml}
                            </div>`;
                }).join('');
            }
            DOMElements.selectionSection.classList.add('active');
        } catch (error) {
             showError('Failed to load insights. Make sure you have run the generate_insights.py script.');
        } finally {
            showLoader(false);
        }
    }
    
    function switchTab(type) {
        currentSearchType = type;
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${type}`).classList.add('active');
        const placeholders = { business: 'Enter active business name...', owner: 'Enter owner/principal name...', address: 'Enter street address...' };
        DOMElements.searchInput.placeholder = placeholders[type];
        DOMElements.searchInput.value = ''; DOMElements.searchInput.focus();
    }
    
    // --- Generic Handlers ---
    const handleEnterKey = (e) => { if (e.key === 'Enter') performSearch(); };
    const showLoader = (show, text = 'Loading...') => { DOMElements.loader.classList.toggle('active', show); DOMElements.loaderText.textContent = text; };
    const showError = (message) => { DOMElements.errorContainer.innerHTML = `<div class="error-message">${message}</div>`; setTimeout(() => DOMElements.errorContainer.innerHTML = '', 5000); };
    
    // --- UPDATED: resetSearch (hides AI button) ---
    function resetSearch(clearInput = true) {
        if (clearInput) {
            DOMElements.searchInput.value = '';
            DOMElements.filterInput.value = '';
        }
        DOMElements.selectionSection.classList.remove('active'); DOMElements.dashboard.classList.remove('active');
        DOMElements.errorContainer.innerHTML = ''; 
        if (DOMElements.networkNoticeInline) DOMElements.networkNoticeInline.innerHTML = '';
        DOMElements.cityFiltersContainer.style.display = 'none';
        DOMElements.aiDigestBtn.style.display = 'none'; // --- HIDE AI BUTTON ---
        DOMElements.propertyTbody.innerHTML = ''; DOMElements.activeBusinessesList.innerHTML = ''; DOMElements.principalsList.innerHTML = '';
        
        allProperties = []; allEntities.clear(); allLinks = {};
        clearCityFilter(false);
        clearEntityFilter(false);
        
        document.querySelector('.content-grid').style.gridTemplateColumns = '';
        document.getElementById('network-panel').style.display = 'flex';
        
        closeReportModal();
        closeAboutModal();
        closeModal();
    }
    
    // --- Modal Handlers ---
    const openAboutModal = () => DOMElements.aboutModal.classList.add('active');
    const closeAboutModal = () => DOMElements.aboutModal.classList.remove('active');
    const closeModal = () => DOMElements.detailModal.classList.remove('active');
    const closeModalOnBackdrop = (e) => { if (e.target.classList.contains('modal')) e.target.classList.remove('active'); };
    
    document.addEventListener('DOMContentLoaded', () => {
        DOMElements.searchInput.focus();
        loadCachedReportsCount();
    });
</script>
</body>
</html>